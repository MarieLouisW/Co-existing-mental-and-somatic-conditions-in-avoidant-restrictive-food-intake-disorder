---
title: "Analysis R script to Wronski et al.: Co-existing mental and somatic conditions in Swedish children with the avoidant restrictive food intake disorder phenotype"
author: "Marie-Louis Wronski, Ralf Kuja-Halkola, Elin Hedlund, Miriam I. Martini, Paul Lichtenstein, Sebastian Lundstr√∂m, Henrik Larsson, Mark Taylor, Nadia Micali, Cynthia M. Bulik, Lisa Dinkler"
output:
  bookdown::html_document2:
    code_folding: show
    toc: yes
    toc_depth: 6
    highlight: tango
    theme: paper
    fig_width: 45
    fig_height: 45
    fig_caption: no
    number_sections: yes
    keep_md: no
    df_print: default
editor_options: 
  markdown: 
    wrap: 72
---

# Preliminaries

Abbreviations:

ARFID: Avoidant Restrictive Food Intake Disorder
MS: Manuscript
SM: Supplementary Material


## Packages

```{r packages, message=FALSE, warning=FALSE}
source("https://sebastiansauer.github.io/Rcode/find_funs.R")

library(tidyverse)
library(lubridate) # Date manipulation
library(xlsx)
library(bookdown)
library(kableExtra)
library(broom.mixed)
library(MASS)
library(geepack)
library(ggsci)
library(cowplot) 
library(ggpubr)
library(ggsignif)
library(ggpattern)
library(ggtext)
library(ggrepel)
library(ggpp)
library(ggbreak)
library(gg.gap)
library(lemon)
library(grid)
library(emmeans)
library(purrr)
library(survival)
library(timereg)
library(survminer)
library(drgee)
library(stdReg)
library(splines)
library(sandwich)
library(pscl)
library(poissonreg)
library(censReg)
library(AER)
library(sjPlot)
library(plotrix)
library(scales)
library(MatchIt)
library(sampling)
library(Rcpp)
library(rcartocolor) # Color blindness
library(gridExtra)

options(scipen=999)

asterisk_function <- function(x) {
  ifelse(is.na(x), NA, 
  symnum(x, corr=FALSE, na=FALSE, legend=FALSE,
         cutpoints=c(0, 0.001, 0.01, 0.05, 1), 
         symbols=c("***", "**", "*", "")))}


# find_funs("coxph")
# find_funs("survSplit")
# find_funs("survfit")
# find_funs("matchit")
# find_funs("glm")
# find_funs("vcovCL")
```


## Read data sets

```{r datasets, message=FALSE, warning=FALSE, results="asis"}
df_catss9 <- read_csv("P:\ARFID_CATSS\ARFID_CATSS_Research\_Data\Analysis_data\catss9.csv")

df_bym <- read_csv("P:\ARFID_CATSS\ARFID_CATSS_Research\_Data\Analysis_data\byrmon.csv")

df_ops <- read_csv("P:\ARFID_CATSS\ARFID_CATSS_Research\_Data\Analysis_data\npr.csv") %>%
  dplyr::rename(age.at.diag=age_at_diag) %>%
  mutate(Diagnos=NA, Diag_nr=NA) %>%
  dplyr::select(twin_id, in_yrmon, out_yrmon, age.at.diag, vtid, source, 
                Diagnos, Diag_nr, Op)

df_npr_full <- read_csv("P:\ARFID_CATSS\ARFID_CATSS_Research\_Data\Analysis_data\npr.csv") %>%
  dplyr::rename(age.at.diag=age_at_diag) %>%
  dplyr::select(twin_id, in_yrmon, out_yrmon, age.at.diag, vtid, source, 
                Diagnos, Diag_nr, Op) %>%
  bind_rows(df_ops) %>% # Bind additional OP codes
  mutate(vtid=vtid+1) # Add 1 day to inpatient duration to account for admission + discharge days

df_pdr <- read_csv("P:\ARFID_CATSS\ARFID_CATSS_Research\_Data\Analysis_data\pdr.csv") %>%
  dplyr::rename(age.at.fdate=age_at_fdate) %>%
  dplyr::select(twin_id, age.at.fdate, ATC)

df_endfollowup <- read_csv("P:\ARFID_CATSS\ARFID_CATSS_Research\_Data\Analysis_data\endoffollowup.csv") %>%
  dplyr::rename(age.at.npr.end=age_at_npr_end)


# Censoring: Death or Emigration
df_cens <- read_csv("P:\ARFID_CATSS\ARFID_CATSS_Research\_Data\Analysis_data\emideadages.csv") %>%
  dplyr::rename(age.at.death=age_at_death, age.at.emidate=age_at_emidate) %>%
  dplyr::select(twin_id, age.at.death, age.at.emidate) %>%
  mutate(cens.age=ifelse(is.na(age.at.death), age.at.emidate, age.at.death))
  
# Internal data consistency check: Check twins/birth year where NPR data are missing
# df_catss9 %>% dplyr::select(twin_id, byear) %>% anti_join(df_npr_full, by="twin_id") %>%
#   count(byear) %>%
#   arrange(desc(byear)) %>%
#   knitr::kable(digits=0, align="l",
#                caption="Number of twins without health register data per birth year") %>%
#   kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
#               html_font="Arial", font_size="10")
```

# ARFID phenotype at age 9 or 12 years

```{r arfiddx, message=FALSE, warning=FALSE}
df_crit <- df_catss9 %>%
  dplyr::select(
    twin_id, pair_id, tvab, sex, byear, bestzyg, healthreg,        
    # Weight & height
    PRESENT_LENGHT_CM, PRESENT_WEIGHT_KG,
    # A-TAC Perception items
    ATAC_B9, ATAC_B10, ATAC_B16, ATAC_B18, ATAC_B19, ATAC_BB1, ATAC_BB2, 
    # A-TAC Eating items
    ATAC_L138, ATAC_L145, ATAC_L148, ATAC_LL1, ATAC_LL2,
    # A-TAC autism scale
    autismgrind_cutoff_h) %>%
    # Replace missing tvabs with last digit of the respective twin_id
  mutate(tvab=ifelse(is.na(tvab), substr(twin_id, 9, 9), tvab)) %>% 
  # Zygosity: levels 1 - MZ, 2 - DZ-ss, 3 - unknown, 4 - DZ-os
  mutate(zyg=factor(bestzyg, levels=c(1,2,3,4), 
                    labels=c("MZ", "DZ-ss", "unknown", "DZ-os"))) %>% 
  
  # A priori remove twins without NPR data
   filter(healthreg==1) %>%
  
  # A priori remove twins with unknown zygosity and missing co-twin
  #filter(zyg!="unknown") %>%
  group_by(pair_id) %>%
  mutate(ind_singletwin=ifelse(n()<2, 1, 0)) %>%
  #filter(n()==2) %>%
  ungroup() %>%
  
  
  left_join(df_bym, by="twin_id") %>% 
  left_join(df_endfollowup, by="twin_id") %>% 
  
  # Remove participants who have withdrawn their consent
  mutate(ind_withdrawn=ifelse(is.na(age.at.npr.end), 1, 0)) %>% 
  filter(ind_withdrawn==0) %>% 
  
  # A1 - Impact on weight and height - Preparation 
  # Get BMI & define whether twin is 9 or 12 years old in CATSS
  mutate(bmi912=PRESENT_WEIGHT_KG/
           ((PRESENT_LENGHT_CM/100)*(PRESENT_LENGHT_CM/100)),
         bmi912_rounded=round(bmi912, digits=2)) %>% 
  mutate(b_date=as_date(paste0(byrmon, "01"))) %>%
  # First 3 birth cohorts 12 years old, others 9 years old (cutoff June 30, 1995)
  mutate(catss_age=factor(ifelse(b_date>"1995-06-30", "9y", "12y"))) %>%
  mutate(sex_fctr=factor(sex, levels=c(1,2), labels=c("m", "f"))) %>% 
  mutate(sex=ifelse(sex==1,0,1)) %>% # recode to binary 0 (male) and 1 (female) 
  group_by(sex_fctr, catss_age) %>%
  

  # Define twins with BMI lower than 5th age- and sex-specific percentile
  mutate(bmi912_lt5thperc=ifelse(bmi912<quantile(bmi912, probs=0.05,
                                                 na.rm=TRUE),
                                 1,
                                 0)) %>%
  ungroup() %>%
  
  
  left_join(df_npr_full, by="twin_id") %>%                 
  left_join(df_pdr, by="twin_id") %>% 
  left_join(df_cens, by="twin_id") %>% 
  
  # NPR diagnoses
  mutate(Diagnos_spec=
           case_when(
             ### Criterion A - FED or ED dx ###
             # Feeding disorder
             Diagnos=="F982" ~ "F982",
             # Feeding difficulties & mismanagement	
             Diagnos=="783D" ~ "7833", 
             Diagnos=="R633" ~ "R633", 
             # Other/unspecified eating disorder
             Diagnos=="307F" ~ "3075",
             Diagnos=="F508" ~ "F508",
             # Anorexia nervosa
             Diagnos=="307B" ~ "3071",
             Diagnos=="F500" ~ "F500",
             Diagnos=="F501" ~ "F501",
             # EDNOS
             Diagnos=="F509" ~ "F509",
             
           ### Criterion A - Avoidant/restrictive eating ###
             # Loss of appetite
             Diagnos=="783A" ~ "7830", 
             Diagnos=="R630" ~ "R630",
             
           ### Criterion A1 - Weight loss/failure to thrive ###
             # Weight loss/failure to thrive
             grepl("^783C|^783E|^R628|^R634", Diagnos) ~ "a1_thrive", 
             
             # Tx weight gain/retaining weight
             grepl("^AV112|^PE006|^QE010", Op) ~ "a1_weight",
             
           ### Criterion A2 - Nutritional deficiencies ###
             # Nutritional anemia
             grepl("^280B|^280W|^280X|^281|^D501|^D508|^D509|
                   ^D513|^D518|^D519|^D520|^D528|^D529|^D53", 
                   Diagnos) ~ "a2_nutr_anem",
             
             # Nutritional deficiencies (NOT: 268, E55 - Vit D)
             grepl("^26|^E4|^E5|^E60|^E61|^E62|^E63|^E64", 
                   Diagnos) & !grepl("^268|^E55", Diagnos) ~ "a2_nutr_def",
           
             # Vit D deficiency
             grepl("^268|^E55",  Diagnos) ~ "vitD_dx",
             
           ### Criterion A3 - Dependence on supplements ### 
             # Tube feeding
             grepl("^DJ010|^DV065|^TJD00|^TJD10|^TJD20|^TJF10|^JDB00|^JDB01|
                   ^JDB10|^4440|^4490|^51", 
                   Op) ~ "a3_tube",
             grepl("^V551|^Z431|^V441|^Z931", Diagnos) ~ "a3_tube",
           
             # Nutritional treatment
             grepl("^AV090|^AV091|^AV092|^DJ012|^DV043|^DV051|
                   ^DV052|^DV053|^DV054|^DV055|^DV056|^QE003|
                   ^QN022|^XS912", Op) ~ "a3_nutr_tx",
             grepl("^Z713", Diagnos) ~ "a3_nutr_tx",
             
           ### Criterion D - Medical conditions for sensitivity analysis ### 
             # Malignant & in situ neoplasms
             grepl("^14|^15|^16|^17|^18|^19|^20|^230|^231|
                   ^232|^233|^234|^C|^D0", Diagnos) ~ "cancer",
             
             # Endocrine & metabolic disorders - NOT: E4-E6 (apply to 
             # criterion A2), 278/E6 (Obesity), 271D/E73 (lactose intolerance)
             grepl("^E|^24|^25|^27", Diagnos) & 
               !grepl("^271D|^278|^E4|^E5|^E6|^E73", Diagnos) ~ "endometa",
             
             # Cerebral palsy + other paralytic syndromes
             grepl("^342|^343|^344|^G8", Diagnos) ~ "cp",
             
             # Diseases of the esophagus
             grepl("^530|^K20|^K210|^K22", Diagnos) ~ "esophagus",
             
             # Non-infectious enteritis & colitis (IBD)
             grepl("^555|^556|^K50|^K51", Diagnos) ~ "ibd",
             
             # Other intestinal diseases
             grepl("^560|^564W|^K56|^K592|^K631", 
                   Diagnos) ~ "otherintes",
             
             # Intestinal malabsorption
             grepl("^579|^K90", Diagnos) & # exclude celiac disease
               !grepl("^K900|^579A", Diagnos) ~ "intesmalab",
             
             # Birth injury to CNS
             grepl("^767A|^767E|^767F|^767H|^P10|^P11", 
                   Diagnos) ~ "birthcns",  
            
             # Congenital malformations
             grepl("^740|^741|^742|^749|^750|^751|^758|^759|
                   ^Q0|^Q35|^Q36|^Q37|^Q38|^Q39|^Q4|^Q9", 
                   Diagnos) ~ "congen",
             
             # Dysphagia
             grepl("^787C|^R13", Diagnos) ~ "dysphagia",
            
             # Intracranial injury - NOT: 850/S060 (concussion)
             grepl("^851|^852|^853|^854|^S06", Diagnos) &
               !grepl("^S060", Diagnos) ~ "braininjury",
            
            ### Psychiatric comorbidities ###
            
             # Autism
             grepl("^299A|^F840|^F841|^F845|^F848|^F849", Diagnos) ~ "autism",
             
             # ADHD
             grepl("^F90", Diagnos) ~ "adhd",
            
             # Bulimia Nervosa
             grepl("^F502|^F503", Diagnos) ~ "bn")) %>%
  
  
  # PDR prescriptions
  mutate(ATC_spec=case_when(
    # Vitamins
    grepl("^A11", ATC) & !grepl("^A11CC", ATC) ~ "A11",
    # Minerals
    grepl("^A12", ATC) ~ "A12",
    # Against anemia
    grepl("^B03", ATC) ~ "B03",
    # Parenteral nutrition
    grepl("^B05BA", ATC) ~ "B05BA",
    # Infusion
    grepl("^B05X", ATC) ~ "B05X",
    # Other nutrients
    grepl("V06D", ATC) ~ "V06D")) %>%
  

  # Feeding or eating disorder dx
  mutate(fed_dx_6to12_long=ifelse((Diagnos_spec %in% c("F982", "R633", 
                                                  "7833", "F508",
                                                  "3075", "F500",
                                                  "F501", "F509")) &
                                    (between(age.at.diag, 6, 11.99999)),
                                  1, 0)) %>% 
  
  # A0 - Avoidant/restrictive eating
  mutate(critA0_6to12_long=ifelse((ATAC_L138>0) | (ATAC_B19==1) |
                                    ((Diagnos_spec %in% c("7830", "R630")) &
                                       (between(age.at.diag, 6, 11.99999))),
                                  1, 0)) %>% 
    
  # A1 - Weight loss, failure to gain weight/grow
  mutate(critA1_6to12_long=ifelse((bmi912_lt5thperc==1) | 
                               (ATAC_L145>0) | 
                               ((Diagnos_spec %in% 
                                   c("a1_thrive", "a1_weight")) &
                                  (between(age.at.diag, 6, 11.99999))),
                                1, 0)) %>% 
    
  # A2 - Nutritional deficiency
  mutate(critA2_6to12_long=ifelse((Diagnos_spec %in% 
                               c("a2_nutr_anem", "a2_nutr_def")) &
                               (between(age.at.diag, 6, 11.99999)),
                               1, 0)) %>% 
  
  # A3 - Dependence on nutritional supplements
  mutate(critA3_6to12_long=ifelse(((ATC_spec %in% c("A11", "A12", 
                                                   "B03", "B05BA", "B05X")) &
                                     (between(age.at.fdate, 6, 11.99999))) |
                                    ((Diagnos_spec %in% 
                                        c("a3_tube", "a3_nutr_tx")) &
                                       (between(age.at.diag, 6, 11.99999))),
                                  1, 0)) %>% 

  # A4 - Psychosocial impairment - Define whether critA4 is met
  mutate(critA4_atac_weight=ifelse(((ATAC_LL1>0) | (ATAC_LL2>0)) & 
                                     (ATAC_L145>0) &
                                     (ATAC_L148==0),
                                   1, 0),
         critA4_atac_sens=ifelse((ATAC_B19==1) & (ATAC_B9!=1) & 
                                   (ATAC_B10!=1) & 
                                   (ATAC_B16!=1) & (ATAC_B18!=1) &
                                   ((ATAC_BB1>0) | (ATAC_BB2>0)), 
                                 1, 0)) %>%
  mutate(critA4_9or12_long=ifelse((critA4_atac_weight==1) | 
                               (critA4_atac_sens==1), 
                             1, 0)) %>%
  
  
  # C - Exclusion of fear of weight gain
  mutate(critC_9or12_long=ifelse(ATAC_L148>0, 1, 0)) %>%
  
  
  # D - Exclusion of medical conditions
  mutate(critD_med_bf12_long=ifelse((Diagnos_spec %in% 
                               c("endometa", "cp",
                                 "esophagus", "ibd",
                                 "otherintes", "intesmalab",
                                 "congen", "dysphagia",
                                 "braininjury")) &
                                 (age.at.diag<12),
                               1, 0)) %>% 
  
  # D - Exclusion of autism diagnosis
  mutate(critD_aut_long=ifelse(Diagnos_spec %in% "autism", 1, 0)) %>%
  
  # VitD deficiency
  mutate(vitD_dx_long=ifelse((Diagnos_spec %in% 
                                c("vitD_dx")) & (between(age.at.diag, 6, 11.99999)),
                             1, 0)) %>%
  mutate(vitD_rx_long=ifelse((grepl("^A11CC", ATC) &
                                (between(age.at.fdate, 6, 11.99999))),
                             1, 0)) %>%
  
  
  # Criteria per twin
  group_by(twin_id) %>%
  mutate(fed_dx_6to12=ifelse(1 %in% fed_dx_6to12_long, 1, 0)) %>%
  mutate(critA0_6to12=ifelse(1 %in% critA0_6to12_long, 1, 0)) %>%
  mutate(critA1_6to12=ifelse(1 %in% critA1_6to12_long, 1, 0)) %>%
  mutate(critA2_6to12=ifelse(1 %in% critA2_6to12_long, 1, 0)) %>%
  mutate(critA3_6to12=ifelse(1 %in% critA3_6to12_long, 1, 0)) %>%
  mutate(critA4_9or12=ifelse(1 %in% critA4_9or12_long, 1, 0)) %>%
  mutate(critC_9or12=ifelse(1 %in% critC_9or12_long, 1, 0)) %>%
  mutate(critD_med_bf12=ifelse(1 %in% critD_med_bf12_long, 1, 0)) %>%
  mutate(critD_aut=ifelse(1 %in% critD_aut_long, 1, 0)) %>%
  
  mutate(vitD_dx=ifelse(1 %in% vitD_dx_long, 1, 0)) %>%
  mutate(vitD_rx=ifelse(1 %in% vitD_rx_long, 1, 0)) %>%
  
  # Cases
  # Define caseA
  mutate(caseA=ifelse((fed_dx_6to12==1) | 
                        ((critA0_6to12==1) &
                                ((critA1_6to12==1) | 
                                   (critA2_6to12==1) | 
                                   (critA3_6to12==1) | 
                                   (critA4_9or12==1))), 
                      1, 0)) %>% 
 
  # Define caseAC
  mutate(caseAC=ifelse((caseA==1) & (critC_9or12==0), 
                       1, 0)) %>%  
  
  # Define caseACD_med
  mutate(caseACD_med=ifelse((caseAC==1) & (critD_med_bf12==0), 
                            1, 0)) %>%
  
  # Define caseACD_aut
  mutate(caseACD_aut=ifelse((caseAC==1) & (autismgrind_cutoff_h==0) & 
                              (critD_aut==0), 
                            1, 0)) %>%

  ungroup()

df_crit_distinct <- df_crit %>%
  distinct(twin_id, .keep_all=TRUE)
```

# Descriptives
## Descriptives I for MS Figure 1 and SM Table S1

```{r casedescr1, message=FALSE, warning=FALSE, results="asis"}
df_crit_distinct %>%
  dplyr::select(twin_id, catss_age) %>%
  count(catss_age) %>%
  mutate(sum=sum(n)) %>%
  mutate(perc=100*(n/sum)) %>%
  knitr::kable(digits=2, align="l",
               caption="Overview: Age at CATSS") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

df_crit_distinct %>%
  dplyr::select(twin_id, catss_age, caseAC) %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  group_by(catss_age) %>%
  count(caseAC) %>%
  mutate(sum=sum(n)) %>%
  mutate(perc=100*(n/sum)) %>%
  knitr::kable(digits=2, align="l",
               caption="Overview: Age at CATSS") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

df_crit_distinct %>%
  dplyr::select(twin_id, catss_age, caseAC, sex) %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), 
                       labels=c("Controls", "ARFID"))) %>%  
  mutate(sex=factor(sex, levels=c(0,1), labels=c("m", "f"))) %>% 
  group_by(catss_age, caseAC) %>%
  count(sex) %>%
  mutate(sum=sum(n)) %>%
  mutate(perc=100*(n/sum)) %>%
  knitr::kable(digits=2, align="l",
               caption="Overview: Age at CATSS (grouped by sex)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")



df_crit_distinct %>%
  dplyr::select(twin_id, fed_dx_6to12, critA0_6to12, caseA, caseAC,
                caseACD_med, caseACD_aut) %>%
  pivot_longer(-twin_id) %>%
  group_by(name) %>%
  count(value) %>%
  knitr::kable(digits=0, align="l",
               caption="CaseA(CD) and cases having FED dx or CritA0") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```


## Descriptives II for MS Figure 1 and SM Table S1

```{r casedescr2, message=FALSE, warning=FALSE, results="asis"}
n_ARFID <- df_crit_distinct %>%
  mutate(n=sum(caseAC==1)) %>% 
  distinct(n) %>%
  pull()
  
n_Control <- df_crit_distinct %>%
  mutate(n=sum(caseAC==0)) %>% 
  distinct(n) %>%
  pull()
  
# Perc ARFID (prevalence)
as_tibble(100*(n_ARFID/(n_ARFID+n_Control))) %>%
  knitr::kable(digits=2, align="l",
               caption="Prevalence of the ARFID phenotype (%)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

# Biological sex
df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(sex=factor(sex, levels=c(0,1), labels=c("m", "f"))) %>% 
  group_by(caseAC) %>%
  count(sex) %>%
  mutate(n_total=sum(n)) %>%
  mutate(perc_sex=100*(n/n_total)) %>%
  pivot_wider(names_from="sex", values_from=c("n", "n_total", "perc_sex")) %>%
  dplyr::select(caseAC, n_f, perc_sex_f, n_m, perc_sex_m) %>%
  knitr::kable(digits=2, align="l",
               caption="Descriptives ARFID and Controls: sex, part 1") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
  
df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(sex=factor(sex, levels=c(0,1), labels=c("m", "f"))) %>% 
  group_by(caseAC) %>%
  count(sex) %>%
  spread(caseAC, n) %>%
  mutate(perc_ARFID=100*(ARFID/(ARFID+Controls))) %>%
  mutate(n_total=ARFID+Controls) %>%
  dplyr::select(sex, ARFID, Controls, n_total, perc_ARFID) %>%
  knitr::kable(digits=2, align="l",
               caption="Descriptives ARFID and Controls: sex, part 2") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

# Birth year 
df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(bygroup=case_when(
    byear %in% c("1992", "1993", "1994", "1995", "1996") ~ "1992-1996",
    byear %in% c("1997", "1998", "1999", "2000") ~ "1997-2000",
    byear %in% c("2001", "2002", "2003", "2004") ~ "2001-2004",
    byear %in% c("2005", "2006", "2007", "2008") ~ "2005-2008")) %>%
  count(bygroup) %>%
  mutate(n_total=sum(n)) %>%
  mutate(perc_byear=100*(n/n_total)) %>%
  knitr::kable(digits=2, align="l",
               caption="Descriptives: birth year") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(bygroup=case_when(
    byear %in% c("1992", "1993", "1994", "1995", "1996") ~ "1992-1996",
    byear %in% c("1997", "1998", "1999", "2000") ~ "1997-2000",
    byear %in% c("2001", "2002", "2003", "2004") ~ "2001-2004",
    byear %in% c("2005", "2006", "2007", "2008") ~ "2005-2008")) %>%
  group_by(caseAC) %>%
  count(bygroup) %>%
  mutate(n_total=sum(n)) %>%
  mutate(perc_byear=100*(n/n_total)) %>%
  knitr::kable(digits=2, align="l",
               caption="Descriptives: birth year (grouped by case)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")

df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>% 
  mutate(sex=factor(sex, levels=c(0,1), labels=c("m", "f"))) %>% 
  mutate(bygroup=case_when(
    byear %in% c("1992", "1993", "1994", "1995", "1996") ~ "1992-1996",
    byear %in% c("1997", "1998", "1999", "2000") ~ "1997-2000",
    byear %in% c("2001", "2002", "2003", "2004") ~ "2001-2004",
    byear %in% c("2005", "2006", "2007", "2008") ~ "2005-2008")) %>%
  group_by(caseAC, sex) %>%
  count(bygroup) %>%
  mutate(n_total=sum(n)) %>%
  mutate(perc_byear=100*(n/n_total)) %>%
  knitr::kable(digits=2, align="l",
               caption="Descriptives: birth year (grouped by case and sex)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")


# Zygosity  
df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  group_by(caseAC, ind_singletwin) %>%
  count(zyg) %>%
  arrange(ind_singletwin) %>%
  mutate(n_total=sum(n)) %>%
  mutate(perc_zyg=100*(n/n_total)) %>%
  knitr::kable(digits=2, align="l",
               caption="Descriptives ARFID and Controls: zygosity 
               (do not include in paper)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, position="left",
              html_font="Arial", font_size="10")
```


## Descriptives III for MS Figure 1 (ARFID phenotype criteria)

```{r casedescr3, message=FALSE, warning=FALSE, results="asis"}  
df_crit_distinct %>% nrow(.)

df_crit_distinct %>%
  dplyr::select(twin_id, fed_dx_6to12, critA0_6to12, caseAC) %>% 
  pivot_longer(-twin_id) %>% 
  group_by(name) %>% 
  count(value)

df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  group_by(caseAC) %>%
  count(sex_fctr) %>%
  mutate(perc=round(100*(n/sum(n)),2))

df_crit %>% 
  filter(fed_dx_6to12==1) %>% 
  filter(Diagnos_spec %in% c("F982", "7833", "R633", "3075",
  "F508", "3071", "F500", "F501", "F509")) %>%
  group_by(Diagnos_spec) %>%
  distinct(twin_id) %>%
  count()


df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(Diagnos_spec %in% c("7830", "R630")) %>%
  group_by(Diagnos_spec) %>%
  distinct(twin_id)  %>%
  count() 


#CATSS9_ParticularFoodsAgeAbove5=ATAC_L138
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(ATAC_L138>0) %>%
  distinct(twin_id) %>%
  count()

#CATSS9_SensitiveFlavorsSmells=ATAC_B19,
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(ATAC_B19==1) %>%
  distinct(twin_id) %>%
  count()


df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA1_6to12==1 | critA2_6to12==1 | critA3_6to12==1 | critA4_9or12==1) %>%
  distinct(twin_id) %>%
  count() 

## Any A1
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA1_6to12==1) %>%
  distinct(twin_id) %>%
  count() 

## Any A2
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA2_6to12==1) %>%
  distinct(twin_id) %>%
  count()

## Any A3
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA3_6to12==1) %>%
  distinct(twin_id) %>%
  count() 

## Any A4
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA4_9or12==1) %>%
  distinct(twin_id) %>%
  count()


## A1
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA1_6to12==1) %>%
  filter(Diagnos_spec %in% c("a1_thrive", "a1_weight")) %>%
  group_by(Diagnos_spec) %>%
  distinct(twin_id)  %>%
  count() 

df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA1_6to12==1) %>%
  filter(ATAC_L145>0) %>%
  distinct(twin_id)  %>%
  count()

df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA1_6to12==1) %>%
  filter(bmi912_lt5thperc==1) %>%
  distinct(twin_id)  %>%
  count() 

## A2
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA2_6to12==1) %>%
  filter(Diagnos_spec %in% c("a2_nutr_anem", "a2_nutr_def")) %>%
  group_by(Diagnos_spec) %>%
  distinct(twin_id)  %>%
  count() 

## A3
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA3_6to12==1) %>%
  filter(ATC_spec %in% c("A11", "A12", "B03", 
                         "B05BA", "B05X", "V06D")) %>%
  group_by(ATC_spec) %>%
  distinct(twin_id)  %>%
  count()

df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA3_6to12==1) %>%
  filter(Diagnos_spec %in% c("a3_tube", "a3_nutr_tx")) %>%
  group_by(Diagnos_spec) %>%
  distinct(twin_id)  %>%
  count()

## A4
df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA4_9or12==1) %>% 
  filter((critA4_atac_weight==1)) %>%
  distinct(twin_id)  %>%
  count()

df_crit %>% 
  filter(critA0_6to12==1) %>% 
  filter(critA4_9or12==1) %>% 
  filter((critA4_atac_sens==1)) %>%
  distinct(twin_id)  %>%
  count() 


# Crit. C
df_crit_distinct %>%
  filter(caseA==1) %>%
  filter(critC_9or12==1) %>%
  distinct(twin_id) %>%
  count()
```

## Descriptives IV for SM Table S1 (Chi-squared tests)

```{r chisquared, message=FALSE, warning=FALSE}
# test 1
chisq_sex <- df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(sex=factor(sex, levels=c(0,1), labels=c("m", "f")))

xtabs(~chisq_sex$caseAC + chisq_sex$sex)

chisq.test(chisq_sex$caseAC, chisq_sex$sex)


# test 2
chisq_catss <- df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID")))

xtabs(~chisq_catss$caseAC + chisq_catss$catss_age)

chisq.test(chisq_catss$caseAC, chisq_catss$catss_age)


# test 3
chisq_by <- df_crit_distinct %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(bygroup=case_when(
    byear %in% c("1992", "1993", "1994", "1995", "1996") ~ "1992-1996",
    byear %in% c("1997", "1998", "1999", "2000") ~ "1997-2000",
    byear %in% c("2001", "2002", "2003", "2004") ~ "2001-2004",
    byear %in% c("2005", "2006", "2007", "2008") ~ "2005-2008")) 

xtabs(~chisq_by$caseAC + chisq_by$bygroup)

chisq.test(chisq_by$caseAC, chisq_by$bygroup)
```


# Define comorbidities - ICD chapters, individual/single diagnoses, and grouped conditions (SM Table S2)

```{r comorbprep, message=FALSE, warning=FALSE}
df_comorb_all <- df_crit %>%
  
  # Psychiatric vs. somatic
  mutate(comorb_mental=case_when(
    grepl("^F|^29|^30|^31", Diagnos) ~"MentalConditions")) %>%
  
  mutate(comorb_somatic=case_when(
    !is.na(Diagnos) & !grepl("^F|^29|^30|^31", Diagnos) ~"SomaticConditions")) %>%
  
  
  # ICD chapters
  mutate(comorb_chapters=
           case_when(
             grepl("^C|^D0|^14|^15|^16|^17|^18|^19|^20|^230|^231|
                   ^232|^233|^234", Diagnos) ~"FurtherConditions.EntireChapterC:Cancer",
             
             grepl("^E|^24|^25|^26|^27", Diagnos) ~"ChapterE:EndocrineConditions.EntireChapter",
             
             grepl("^F|^29|^30|^31", Diagnos) ~"ChapterF:MentalConditions.EntireChapter",
             
             grepl("^I|^39|^40|^41|^42|^43|^44|^45", Diagnos) ~"ChapterI:CirculatoryConditions.EntireChapter",
             
             grepl("^J|^46|^47|^48|^49|^50|^51", Diagnos) ~"ChapterJ:RespiratoryConditions.EntireChapter",
             
             grepl("^K|^52|^53|^54|^55|^56|^57", Diagnos) ~"ChapterK:DigestiveConditions.EntireChapter",
             
             grepl("^P|^76|^77", Diagnos) ~"ChapterP:PerinatalConditions.EntireChapter",
             
             grepl("^Q|^74|^75", Diagnos) ~"ChapterQ:CongenitalConditions.EntireChapter")) %>%
  
  
  
  # ICD diagnoses (grouped)
  mutate(comorb_diagnoses=
            case_when(
              
            # Diagnoses from E chapter
            grepl("^E00|^E01|^E02|^E03|^E04|^E05|^E06|^E07|^240|^241|^242|^243|^244|^245|^246", 
                  Diagnos) ~"ChapterE:EndocrineConditions.ThyroidConditions",
            grepl("^E10|^E11|^E12|^E13|^E14|^250", Diagnos) ~"ChapterE:EndocrineConditions.DiabetesMellitus",
            grepl("^E23|^253", Diagnos) ~"ChapterE:EndocrineConditions.PituitaryConditions",
            grepl("^E30|^259A|^259B", Diagnos) ~"ChapterE:EndocrineConditions.PubertyOnset",
            grepl("^E343|^259E", Diagnos) ~"ChapterE:EndocrineConditions.ShortStature",
            grepl("^E66|^278", Diagnos) ~"ChapterE:EndocrineConditions.Obesity",
            grepl("^E73|^271D", Diagnos) ~"ChapterE:EndocrineConditions.LactoseIntolerance",
            grepl("^E86|^276F", Diagnos) ~"ChapterE:EndocrineConditions.VolumeDepletion",
            # low prevalence
            grepl("^E713|^E78|^272", Diagnos) ~"ChapterE:EndocrineConditions.LipidMetabolism",
            grepl("^E84|^277A", Diagnos) ~"ChapterE:EndocrineConditions.CysticFibrosis",
            grepl("^E87|^276", Diagnos) & !grepl("^276F", Diagnos) ~"ChapterE:EndocrineConditions.OtherFluidHomeostasis",
            
            # Diagnoses from F chapter
            grepl("^F32|^F33|^F341|^296C|^296D|^300E", Diagnos) ~"ChapterF:MentalConditions.Depression",
            grepl("^F40|^300C", Diagnos) ~"ChapterF:MentalConditions.Phobias",
            grepl("^F41|^300A", Diagnos) ~"ChapterF:MentalConditions.OtherAnxietyConditions",
            grepl("^F70|^F71|^F72|^F73|^F74|^F75|^F76|^F77|^F78|^F79|^317|^318|^319", 
                  Diagnos) ~"ChapterF:MentalConditions.IntellectualDisability",
            grepl("^F80|^F985|^F986|^315D", Diagnos) ~"ChapterF:MentalConditions.SpeechDevelopment",
            grepl("^F81|^315A|^315B|^315C", Diagnos) ~"ChapterF:MentalConditions.ScholastDevelopment",
            grepl("^F82|^315E", Diagnos) ~"ChapterF:MentalConditions.MotorDevelopment",
            grepl("^F83|^F88|^F89|^315F|^315W|^315X", Diagnos) ~"ChapterF:MentalConditions.OtherDevelopment",
            grepl("^F840|^F841|^F845|^F848|^F849|^299A", Diagnos) ~"ChapterF:MentalConditions.Autism",
            grepl("^F90|^314", Diagnos) ~"ChapterF:MentalConditions.ADHD",
            grepl("^F91|^312", Diagnos) ~"ChapterF:MentalConditions.ConductDisorder",
            grepl("^F93|^F94|^F983|^F988|^F989|^313", Diagnos) ~"ChapterF:MentalConditions.OtherBehaviorEmotion",
            grepl("^F95|^307C", Diagnos) ~"ChapterF:MentalConditions.TicDisorders",
            grepl("^F980|^307G|^F981|^307H", Diagnos) ~"ChapterF:MentalConditions.EnuresisEncopresis",
            # low prevalence
            grepl("^F30|^F31|^296", Diagnos) ~"ChapterF:MentalConditions.BipolarDisorder",
            grepl("^F42|^300D", Diagnos) ~"ChapterF:MentalConditions.ObsessCompulsDisorder",
            grepl("^F45|^300W", Diagnos) ~"ChapterF:MentalConditions.SomatoformDisorders",
            grepl("^F502|^F503", Diagnos) ~"ChapterF:MentalConditions.BulimiaNervosa",

            
            # Diagnoses from G chapter
            grepl("^G40|^345", Diagnos) ~"FurtherConditions.G:Epilepsy",
            grepl("^G80|^G81|^G82|^G83|^342|^343|^344", Diagnos) ~"FurtherConditions.G:CerebralPalsy",
            
            
             # Diagnoses from I chapter
            grepl("^I10|^I11|^I12|^I13|^I14|^I15|^I60|^I61|^I62|^I63|^I64|^I65|^I66|^I67|^I68|^I69|^I70|^I71|^I72|^I73|^I74|^I75|^I76|^I77|^I78|^I79|^401|^402|^403|^404|^405|^430|^431|^432|^433|^434|^435|^436|^437|^438|^440|^441|^442|^443|^444|^445|^446|^447|^448|^449", 
                  Diagnos) ~"ChapterI:CirculatoryConditions.VascArterial",
            grepl("^I26|^I27|^I28|^I30|^I31|^I32|^I33|^I34|^I35|^I36|^I37|^I38|^I39|^I40|^I41|^I42|^I43|^I44|^I45|^I46|^I47|^I48|^I49|^I50|^I51|^I52|^415|^416|^417|^420|^421|^422|^423|^424|^425|^426|^427|^428|^429", 
                  Diagnos) ~"ChapterI:CirculatoryConditions.HeartPulmonary",
            grepl("^I80|^I81|^I82|^I83|^I84|^I85|^I86|^I87|^I88|^I89|^451|^452|^453|^454|^455|^456|^457|^458|^459", 
                  Diagnos) ~"ChapterI:CirculatoryConditions.VascVenousLymphatic",
            
            
            # Diagnoses from J chapter
            grepl("^B950|^J00|^J01|^J02|^J03|^J04|^J05|^J06|^034A|^460|^461|^462|^463|^464|^465", # including code B95.0 for Streptococcus, group A infections
                  Diagnos) ~"ChapterJ:RespiratoryConditions.AcuteUpperRespiratory",
            grepl("^J09|^J10|^J11|^J12|^J13|^J14|^J15|^J16|^J17|^J18|^J20|^J21|^J22|^466|^480|^481|^482|^483|^484|^485|^486|^487|^488|^490", Diagnos) ~"ChapterJ:RespiratoryConditions.AcuteLowerRespiratory",
            grepl("^J30|^477", Diagnos) ~"ChapterJ:RespiratoryConditions.Rhinitis",
            grepl("^J31|^J32|^J33|^J34|^J35|^J36|^J37|^J38|^J39|^470|^471|^472|^473|^474|^475|^476|^478",
                  Diagnos) ~"ChapterJ:RespiratoryConditions.ChronicUpperRespiratory",
            grepl("^J45|^J46|^493", Diagnos) ~"ChapterJ:RespiratoryConditions.Asthma",
            grepl("^J40|^J41|^J42|^J43|^J44|^J47|^491|^492|^494|^496", 
                  Diagnos) ~"ChapterJ:RespiratoryConditions.ChronicLowerRespiratory",
            # too unspecific
            grepl("^J80|^J81|^J82|^J83|^J84|^J85|^J86|^J90|^J91|^J92|^J93|^J94|^J95|^J96|^J97|^J98|^J99|^510|^511|^512|^513|^514|^515|^516|^517|^518|^519", Diagnos) ~"ChapterJ:RespiratoryConditions.OtherRespiratoryConditions",
            
            
             # Diagnoses from K chapter
            grepl("^K01|^K02|^K03|^K07|^K10|^520|^521|^522|^523|^524|^525|^526", 
                  Diagnos) ~"ChapterK:DigestiveConditions.DentofacialAnomalies",
            grepl("^K09|^K11|^K12|^K131|^K137|^K14|^527|^528|^529", 
                  Diagnos) ~"ChapterK:DigestiveConditions.Stomatitis",
            grepl("^K21|^530B", Diagnos) ~"ChapterK:DigestiveConditions.GERD",
            grepl("^K20|^K22|^K26|^K29|^K31|^530|^531|^532|^533|^534|^535|^537|^538", 
                  Diagnos) & !grepl("^530B", Diagnos) ~"ChapterK:DigestiveConditions.OtherUpperGastrointest",
            grepl("^K30|^536W", Diagnos) ~"ChapterK:DigestiveConditions.Dyspepsia",
            grepl("^K35|^K36|^K37|^540|^541|^542|^543", Diagnos) ~"ChapterK:DigestiveConditions.Appendicitis",
            grepl("^K40|^K41|^K42|^K43|^K44|^K45|^K46|^550|^551|^552|^553", Diagnos) ~"ChapterK:DigestiveConditions.Hernia",
            grepl("^K50|^K51|^K522|^K528|^K529|^555|^556|^558D", Diagnos) ~"ChapterK:DigestiveConditions.NoninfectiveIBD",
            grepl("^K56|^560B", Diagnos) ~"ChapterK:DigestiveConditions.Ileus",
            grepl("^K58|^K598|^K599|564B|^564W|^564X", Diagnos) ~"ChapterK:DigestiveConditions.IBS",
            grepl("^K590|^564A", Diagnos) ~"ChapterK:DigestiveConditions.Constipation",
            grepl("^K591|^564F", Diagnos) ~"ChapterK:DigestiveConditions.Diarrhea",
            grepl("^K60|^K61|^K62|^K64|^565|^566|^569A|^569B|^569C|^569D|^569E", 
                  Diagnos) ~"ChapterK:DigestiveConditions.AnusRectumConditions",
            grepl("^K90|^579", Diagnos) ~"ChapterK:DigestiveConditions.CeliacDisease",
            grepl("^K920|^K921|^K922|^578", Diagnos) ~"ChapterK:DigestiveConditions.GastrointestinalBleeding",
            # low prevalence
            grepl("^K70|^K71|^K72|^K73|^K74|^K75|^K76|^K77|^K83|^570|^571|^572|^573|^574|^575|^576|^577", Diagnos) 
            ~"ChapterK:DigestiveConditions.BiliarySystemConditions",
            #grepl("^K50|^K51|^555|^556", Diagnos) ~"ChapterK:DigestiveConditions.CrohnColitisUlcerosa",
            
            
            # Diagnoses from L chapter
            grepl("^L10|^L11|^L12|^L13|^L14|^694", Diagnos) ~"FurtherConditions.L:BullousDermatitis",
            grepl("^L20|^L21|^L22|^L23|^L24|^L27|^L28|^L29|^L30|^690B|^691|^692|^693|^697|^698",
                  Diagnos) ~"FurtherConditions.L:OtherDermatitisEczema",
            grepl("^L40|^L41|^L42|^L43|^L44|^L45|^696", Diagnos) ~"FurtherConditions.L:Psoriasis",
            grepl("^L50|^708", Diagnos) ~"FurtherConditions.L:Urticaria",
            
            
            # Diagnoses from M Chapter - low prevalence
            grepl("^M08|^714D", Diagnos) ~"FurtherConditions.M:JuvenileArthritis",
            
            
            # Diagnoses from N Chapter - low prevalence
            grepl("^N04|^581", Diagnos) ~"FurtherConditions.N:NephroticSyndrome",
            grepl("^N91|^N92|^N93|^N94|^625|^626", Diagnos) ~"FurtherConditions.N:MenstruationProblems",
            
            # Diagnoses from P Chapter 
            grepl("^P00|^P01|^P02|^P03|^P04|^760|^761|^762|^763", Diagnos) ~"ChapterP:PerinatalConditions.MaternalComplications",
            grepl("^P05|^P07|^764|^765", Diagnos) ~"ChapterP:PerinatalConditions.FetalGrowthRetardation",
            grepl("^P10|^P11|^P52|^P90|^P91|^767A|^767E|^767F|^767H|^772B|^772C|^779A|^779B|^779C", 
                  Diagnos) ~"ChapterP:PerinatalConditions.PerinatCNSConditions",
            grepl("^P20|^P21|^P22|^P23|^P24|^P25|^P26|^P27|^P28|^P29|^768|^769|^770", 
                  Diagnos) ~"ChapterP:PerinatalConditions.PerinatRespiratCardiovasc",
            grepl("^P35|^P36|^P37|^P38|^P39|^771", Diagnos) ~"ChapterP:PerinatalConditions.PerinatInfections",
            grepl("^P54|^P55|^P61|^776", Diagnos) ~"ChapterP:PerinatalConditions.PerinatHematologic",
            grepl("^P58|^P59|^774", Diagnos) ~"ChapterP:PerinatalConditions.NeonatalJaundice",
            grepl("^P70|^P71|^P72|^P73|^P74|^775", Diagnos) ~"ChapterP:PerinatalConditions.PerinatEndocrineMetabolic",
            grepl("^P92|^779D", Diagnos) ~"ChapterP:PerinatalConditions.PerinatFeeding",
            
            
            # Diagnoses from Q Chapter
            grepl("^Q00|^Q01|^Q02|^Q03|^Q04|^Q05|^Q06|^Q07|^741|^742", Diagnos) ~"ChapterQ:CongenitalConditions.NervousSystemMalform",
            grepl("^Q10|^Q11|^Q12|^Q13|^Q14|^Q15|^Q16|^Q17|^Q18|^743|^744", Diagnos) ~"ChapterQ:CongenitalConditions.HeadMalform",
            grepl("^Q20|^Q21|^Q22|^Q23|^Q24|^Q25|^Q26|^Q27|^Q28|^745|^746|^747", 
                  Diagnos) ~"ChapterQ:CongenitalConditions.CirculatorySystemMalform",
            grepl("^Q35|^Q36|^Q37|^Q38|^Q39|^Q40|^Q41|^Q42|^Q43|^Q44|^Q45|^749|^750|^751", 
                  Diagnos) ~"ChapterQ:CongenitalConditions.DigestiveSystemMalform",
            grepl("^Q50|^Q51|^Q52|^Q53|^Q54|^Q55|^Q56|^752", Diagnos) ~"ChapterQ:CongenitalConditions.GenitalMalform",
            grepl("^Q60|^Q61|^Q62|^Q63|^Q64|^753", Diagnos) ~"ChapterQ:CongenitalConditions.UrinarySystemMalform",
            grepl("^Q65|^Q66|^Q67|^Q68|^Q69|^Q70|^Q71|^Q72|^Q73|^Q74|^Q75|^Q76|^Q77|^Q78|^Q79|^754|^755|^756", Diagnos) ~"ChapterQ:CongenitalConditions.MusculoskeletalMalform",
            grepl("^Q90|^Q91|^Q92|^Q93|^Q94|^Q95|^Q96|^Q97|^Q98|^Q99|^758", Diagnos) ~"ChapterQ:CongenitalConditions.ChromosomalAbnorm",
            # low prevalence
            grepl("^Q30|^Q31|^Q32|^Q33|^Q34|^748", Diagnos) ~"ChapterQ:CongenitalConditions.RespiratorySystemMalform",
            
            
            # Diagnoses from S Chapter 
            grepl("^S06|^850|^851|^852|^853|^854", Diagnos) ~"FurtherConditions.S:IntracranialInjury",
            
            
            # Diagnoses from R Chapter 
            grepl("^R11|^787A|^536C", Diagnos) ~"FurtherConditions.R:NauseaVomiting",
            grepl("^R13|^787C", Diagnos) ~"FurtherConditions.R:Dysphagia",
            grepl("^R560|^780D", Diagnos) ~"FurtherConditions.R:FebrileSeizures",
            grepl("^R620|^R629", Diagnos) ~"FurtherConditions.R:PhysiologicalDevelopment")) %>%



  # Condition groups
  mutate(comorb_disordergroups=
            case_when(
              grepl("^E063|^E10|^K50|^K51|^L10|^L11|^L12|^L13|^L14|^L20|^L40|^L41|^L42|^L43|^L44|^L45|^M08|^245C|^250A|^555|^556|^691W|^694|^696|^714D", Diagnos) 
              ~"GroupedConditions.AutoimmuneConditions",
              grepl("^J30|^J45|^J46|^K522|^L23|^L50|^477|^493|^558D|^692X|^708", Diagnos)
              ~"GroupedConditions.AllergicConditions",
              grepl("^B950|^041|^D89|^279|^G96|^349", Diagnos)
              ~"GroupedConditions.PANS_PANDAS"))

## PANS/PANDAS codes
# B95.0, 041.01
# D89.89, D89.9, 279.8, 279.9
# G96.8, 349.89
```


# ICD Chapters - Preparation and Descriptives (MS)

Calculation of percentages is based on total number of ARFID
cases/Controls (also for sexes and age groups)

```{r comorbchapters, message=FALSE, warning=FALSE, results="asis"}
# How many ARFID children have at least 1 condition (any condition)?
df_comorb_all %>%
  filter(!is.na(comorb_chapters) | !is.na(comorb_diagnoses) | 
           !is.na(comorb_disordergroups)) %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  count(caseAC) %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(perc=ifelse(caseAC=="Controls", 100*(n/n_Control), 100*(n/n_ARFID))) %>%
  #filter(caseAC=="ARFID") %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="How many ARFID children have at least 1 condition (any of the assessed)?") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

# How many ARFID children have at least 1 mental condition?
#	ARFID: 35.88% (see F chapter analysis)
# Controls: 11.25%

# How many ARFID children have at least 1 somatic condition?
# df_comorb_all %>%
#   filter(!is.na(comorb_somatic)) %>%
#   distinct(twin_id, .keep_all=TRUE) %>%
#   count(caseAC) %>%
#   mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
#   mutate(perc=ifelse(caseAC=="Controls", 100*(n/n_Control), 100*(n/n_ARFID))) %>%
#   #filter(caseAC=="ARFID") %>%
#   knitr::kable(format="html", align="l", digits=2,
#                caption="How many ARFID children have at least 1 somatic condition?") %>%
#   kable_paper(bootstrap_options="striped", full_width=FALSE, 
#               position="left", html_font="Arial", font_size="10")


# Chapter-level Descriptives
df_comorb_chapters_pre_pre <- df_comorb_all %>%
  dplyr::select(-c(comorb_diagnoses, comorb_disordergroups)) %>%
  filter(!is.na(comorb_chapters)) %>%
  group_by(comorb_chapters, twin_id) %>%
  slice_min(age.at.diag, n=1) %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  ungroup() %>%
  mutate(dxevent=1) %>%
  mutate(age.at.diag=ifelse(age.at.diag<=0, 0.0001/sqrt(2), age.at.diag)) %>% # slightly adjust 0 time (in reality >0) (otherwise exclusion)
  filter(age.at.diag<18) %>% # Filter age below 18 years
  dplyr::select(twin_id, comorb_chapters, dxevent, age.at.diag) %>%
  pivot_wider(names_from="comorb_chapters",
              values_from=c("dxevent", "age.at.diag"))

df_comorb_chapters_pre <- df_crit_distinct %>% 
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), 
                                           cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>% # Filter age below 18 years
  left_join(df_comorb_chapters_pre_pre, by="twin_id") %>%
  mutate(across(contains("dxevent_"), ~replace_na(.x, 0))) %>%
  mutate(across(contains("age.at.diag_"), ~ifelse(is.na(.x), 
                                                  age.at.end.of.followup, .x))) %>%
  dplyr::select(twin_id, pair_id, caseAC, sex, byear,
                contains("dxevent_"), contains("age.at.diag_")) %>%
  pivot_longer(contains(c("dx", "age.at.diag")), names_to="comorb") %>%
  separate(comorb, c("variable", "comorb"), sep="_", remove=TRUE) %>%
  pivot_wider(names_from="variable", values_from="value") %>%
  mutate(byear=factor(byear))

df_comorb_chapters_filter <- df_comorb_chapters_pre %>%
  group_by(comorb, caseAC) %>%
  count(dxevent) %>% # We will not report data on subgroups with fewer than 5 individuals to ensure that single individuals cannot be identified.
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>% # Ensure that caseAC 0/1 are both represented.
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>% # Minimum count (n) 5 individuals per group.
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)

df_comorb_chapters <- df_comorb_chapters_pre %>%
  anti_join(df_comorb_chapters_filter, by="comorb")


df_comorb_chapters %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  filter(dxevent==1) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview ICD chapters: N of events overall") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


Cancer Chapter: diagnoses/further investigations

Internal data consistency checks (included for transparency, no relevant output)

```{r cancerexpl, message=FALSE, warning=FALSE, results="asis", eval=FALSE}
cancer_last_join <- df_comorb_all %>%
  dplyr::select(-c(comorb_diagnoses, comorb_disordergroups)) %>%
  group_by(twin_id) %>%
  mutate(A0_ind_diag=sum(ifelse(str_detect(Diagnos_spec, "7830|R630"),
                                TRUE, FALSE), na.rm=TRUE)) %>% #>0 means positive
  ungroup() %>%
  filter(comorb_chapters=="ChapterC:Cancer.Chapter") %>%
  group_by(comorb_chapters, twin_id) %>%
  slice_max(age.at.diag, n=1) %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  ungroup() %>% 
  filter(caseAC==1) %>%
  arrange(twin_id) %>%
  dplyr::select(twin_id, age.at.diag, Diag_nr, 
                fed_dx_6to12, 
                critA0_6to12, ATAC_L138, ATAC_B19, A0_ind_diag,
                critA1_6to12, critA2_6to12, 
                critA3_6to12, critA4_9or12) %>%
  dplyr::rename(age.at.last.diag=age.at.diag,
                lastdiag_nr.prio=Diag_nr,
                FeedingEatingDisorder=fed_dx_6to12,
                A0_AvoidantRestrictiveEating=critA0_6to12,
                CATSS9_ParticularFoodsAgeAbove5=ATAC_L138,
                CATSS9_SensitiveFlavorsSmells=ATAC_B19,
                A1_WeightLossFailureThrive=critA1_6to12,
                A2_NutritionalDeficiencies=critA2_6to12,
                A3_DependenceSupplements=critA3_6to12,
                A4_PsychosocialImpairment=critA4_9or12)

df_comorb_chapters %>%
  filter(comorb=="ChapterC:Cancer.Chapter") %>%
  filter(dxevent==1) %>%
  filter(caseAC==1) %>%
  left_join(cancer_last_join, by="twin_id") %>%
  arrange(twin_id) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Exploratory: Cancer diagnoses - Age at first and last diagnosis, diagnosis prioritization (Diag_nr) at last diagnosis, ARFID-defining criteria") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

df_comorb_chapters %>%
  filter(comorb=="ChapterC:Cancer.Chapter") %>%
  filter(dxevent==1) %>%
  filter(caseAC==1) %>%
  dplyr::select(twin_id) %>%
  mutate(twin_nr=row_number()) %>%
  left_join(df_comorb_all, by="twin_id") %>%
  group_by(twin_id, twin_nr) %>%
  filter(!is.na(comorb_diagnoses)) %>%
  distinct(comorb_diagnoses) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Exploratory: Cancer diagnoses - Other co-existing diagnoses") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


# ICD Diagnoses (individual co-existing mental and somatic conditions) - Preparation and Descriptives (MS)

```{r comorbdiagnoses, message=FALSE, warning=FALSE, results="asis"}
df_comorb_diagnoses_pre_pre <- df_comorb_all %>%
  dplyr::select(-c(comorb_chapters, comorb_disordergroups)) %>%
  filter(!is.na(comorb_diagnoses)) %>%
  group_by(comorb_diagnoses, twin_id) %>%
  slice_min(age.at.diag, n=1) %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  ungroup() %>%
  mutate(dxevent=1) %>%
  mutate(age.at.diag=ifelse(age.at.diag<=0, 0.0001/sqrt(2), age.at.diag)) %>% # slightly adjust 0 time (in reality >0) (otherwise exclusion)
  filter(age.at.diag<18) %>% # Filter age below 18 years
  dplyr::select(twin_id, comorb_diagnoses, dxevent, age.at.diag) %>%
  pivot_wider(names_from="comorb_diagnoses",
              values_from=c("dxevent", "age.at.diag"))

df_comorb_diagnoses_pre <- df_crit_distinct %>% 
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>% # Filter age below 18 years
  left_join(df_comorb_diagnoses_pre_pre, by="twin_id") %>%
  mutate(across(contains("dxevent_"), ~replace_na(.x, 0))) %>%
  mutate(across(contains("age.at.diag_"), ~ifelse(is.na(.x), age.at.end.of.followup, .x))) %>%
  dplyr::select(twin_id, pair_id, caseAC, sex, byear,
                contains("dxevent_"), contains("age.at.diag_")) %>%
  pivot_longer(contains(c("dx", "age.at.diag")), names_to="comorb") %>%
  separate(comorb, c("variable", "comorb"), sep="_", remove=TRUE) %>%
  pivot_wider(names_from="variable", values_from="value") %>%
  mutate(byear=factor(byear)) 

df_comorb_diagnoses_filter <- df_comorb_diagnoses_pre %>%
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>%
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>%
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)

df_comorb_diagnoses <- df_comorb_diagnoses_pre %>%
  anti_join(df_comorb_diagnoses_filter, by="comorb") %>%
  # Other excluded diagnoses
  filter(comorb!="ChapterJ:RespiratoryConditions.OtherRespiratoryConditions") %>%
  filter(comorb!="FurtherConditions.N:MenstruationProblems")

# Overview diagnoses outcomes
df_comorb_diagnoses %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  filter(dxevent==1) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview Diagnoses: N of events overall") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


# Do not report in paper (due to low prevalence)
df_comorb_diagnoses_pre %>%
  semi_join(df_comorb_diagnoses_filter, by="comorb") %>%  
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  filter(dxevent==1) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview diagnoses with low prevalence: N of events (do not report in paper)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

df_comorb_diagnoses %>%
  distinct(comorb) %>%
  mutate(N=nrow(.)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Check: Number of distinct conditions") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

df_comorb_diagnoses %>%
  filter(!str_detect(comorb, "ChapterP")) %>%
  distinct(comorb) %>%
  mutate(N=nrow(.)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Check: Number of distinct conditions (perinatal conditions excluded)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


# Condition groups (across ICD Chapters) - Preparation and Descriptives (MS)

```{r comorbGroupedConditions, message=FALSE, warning=FALSE, results="asis"}
df_comorb_disordergroups_pre_pre <- df_comorb_all %>%
  dplyr::select(-c(comorb_chapters, comorb_diagnoses)) %>%
  filter(!is.na(comorb_disordergroups)) %>%
  group_by(comorb_disordergroups, twin_id) %>%
  slice_min(age.at.diag, n=1) %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  ungroup() %>%
  mutate(dxevent=1) %>%
  mutate(age.at.diag=ifelse(age.at.diag<=0, 0.0001/sqrt(2), age.at.diag)) %>% # slightly adjust 0 time (in reality >0) (otherwise exclusion)
  filter(age.at.diag<18) %>% # Filter age below 18 years
  dplyr::select(twin_id, comorb_disordergroups, dxevent, age.at.diag) %>%
  pivot_wider(names_from="comorb_disordergroups",
              values_from=c("dxevent", "age.at.diag"))

df_comorb_disordergroups_pre <- df_crit_distinct %>% 
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>% # Filter age below 18 years
  left_join(df_comorb_disordergroups_pre_pre, by="twin_id") %>%
  mutate(across(contains("dxevent_"), ~replace_na(.x, 0))) %>%
  mutate(across(contains("age.at.diag_"), ~ifelse(is.na(.x), age.at.end.of.followup, .x))) %>%
  dplyr::select(twin_id, pair_id, caseAC, sex, byear,
                contains("dxevent_"), contains("age.at.diag_")) %>%
  pivot_longer(contains(c("dx", "age.at.diag")), names_to="comorb") %>%
  separate(comorb, c("variable", "comorb"), sep="_", remove=TRUE) %>%
  pivot_wider(names_from="variable", values_from="value") %>%
  mutate(byear=factor(byear)) 

df_comorb_disordergroups_filter <- df_comorb_disordergroups_pre %>%
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>%
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>%
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)

df_comorb_disordergroups <- df_comorb_disordergroups_pre %>%
  anti_join(df_comorb_disordergroups_filter, by="comorb")

df_comorb_disordergroups %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  filter(dxevent==1) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview Condition groups: N of events overall") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

## Case numbers for SM Table S2

```{r casenumbers, message=FALSE, warning=FALSE, results="asis"}
df_comorb_diagnoses_pre %>%
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  ungroup() %>%
  filter(dxevent==1) %>%
  filter(caseAC==1) %>% # Filter ARFID cases only
  dplyr::select(comorb, n) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="N of events in ARFID (for SM Table S2) - I") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

df_comorb_chapters_pre %>%
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  ungroup() %>%
  filter(dxevent==1) %>%
  filter(caseAC==1) %>% # Filter ARFID cases only
  dplyr::select(comorb, n) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="N of events in ARFID (for SM Table S2) - II") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

df_comorb_disordergroups_pre %>%
  group_by(comorb, caseAC) %>%
  count(dxevent) %>%
  ungroup() %>%
  filter(dxevent==1) %>%
  filter(caseAC==1) %>% # Filter ARFID cases only
  dplyr::select(comorb, n) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="N of events in ARFID (for SM Table S2) - III") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


# Cox regression models

## ICD Chapters

### MS: Crude model (Main analysis 1)

```{r coxchaptersbase, message=FALSE, warning=FALSE, results="asis"}
coxreg_base <- df_comorb_chapters %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, sex, byear) %>%
  nest(-comorb) %>%
  mutate(
    coxmod=map(data, ~coxph(Surv(age.at.diag, dxevent) ~ caseAC + sex + byear, # Binary predictors are numeric (no factors)
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95,
                                  exponentiate=TRUE))) %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_base %>%
  filter(term=="caseAC") %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="MS - ICD chapters: Cox regression base (adjusted for sex and birth year)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10") #%>%
  #row_spec(which(coxreg_base$term=="caseAC"), background=grey(0.75), bold=TRUE)
```

#### SM: Sex strata (Supplementary analysis 1)

```{r coxchapterssexstrata, message=FALSE, warning=FALSE, results="asis"}
chapters_sex_filter <- df_comorb_chapters %>%
  group_by(comorb, caseAC, sex) %>%
  count(dxevent) %>%
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>%
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>%
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)

barplotdata_chapters_sex <- df_comorb_chapters %>%
  anti_join(chapters_sex_filter, by="comorb") %>%  
  mutate(caseAC=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls"))) %>% 
  mutate(sex=factor(sex, levels=c(0,1), labels=c("m", "f"))) %>% 
  group_by(comorb, caseAC, sex) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%  
  ungroup() %>%
  filter(dxevent==1) %>% 
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  dplyr::select(chind, label, caseAC, sex, n, perc, perc_f)

barplotdata_chapters_sex %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Overview ICD chapters: N of events per sex") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

# Sex differences
coxreg_sexstrata <- df_comorb_chapters %>%
  anti_join(chapters_sex_filter, by="comorb") %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, byear, sex) %>%
  nest(-comorb) %>%
  mutate(
    coxmod=map(data, ~coxph(Surv(age.at.diag, dxevent) ~
                              survival::strata(factor(sex)):(caseAC+byear),
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95,
                                  exponentiate=TRUE)),
    coxmod_HRcomp=map(data, ~coxph(Surv(age.at.diag, dxevent) ~
                                     survival::strata(factor(sex))*(caseAC+byear),
                                   cluster=pair_id, data=.x)),
    tidy_coxmod_HRcomp=map(coxmod_HRcomp, ~tidy(.x, conf.int=TRUE, conf.level=0.95,
                                                exponentiate=TRUE)))

coxreg_sexstrata_persex <- coxreg_sexstrata %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_sexstrata_persex %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - ICD chapters: Cox regression (adjusted for birth year) sex stratified") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

## Sex differences: compare HRs
coxreg_sexstrata_compsex <- coxreg_sexstrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup() 

coxreg_sexstrata_compsex %>%
  #arrange(p.value) %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - ICD chapters: Cox regression (adjusted for birth year) sex stratified - Compare HRs (HR = ratio, equals HR female/HR male)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

#### SM: Time/age group varying model (Supplementary analysis 1)

```{r coxchaptersagestrata, message=FALSE, warning=FALSE, results="asis"}
chapters_age_filter <- df_comorb_chapters %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, byear) %>%
  nest(-comorb) %>%
  mutate(
  data_timevar=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ ., data=.x,
                                      event="dxevent", cut=
                                      c(5.99999, 11.99999), 
                                      episode="timegroup"))) %>%
  dplyr::select(-data) %>%
  unnest(data_timevar) %>%
  group_by(comorb, caseAC, timegroup) %>%
  count(dxevent) %>%
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>%
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>%
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)

barplotdata_chapters_age <- df_comorb_chapters %>%
  anti_join(chapters_age_filter, by="comorb") %>%  
  nest(-comorb) %>%
  mutate(
  data_timevar=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ .,
                                    data=.x,
                                      event="dxevent", cut=
                                      c(5.99999, 11.99999), 
                                      episode="timegroup"))) %>%
  dplyr::select(-data) %>%
  unnest(data_timevar) %>%
  group_by(comorb, caseAC, timegroup) %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(timegroup=factor(timegroup, levels=c(1,2,3), labels=c("0to6", "6to12", "12to18"))) %>% 
  group_by(comorb, caseAC, timegroup) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%  
  ungroup() %>%
  filter(dxevent==1) %>% 
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  dplyr::select(chind, label, caseAC, timegroup, n, perc, perc_f)

barplotdata_chapters_age %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Overview ICD chapters: N of events per age group") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


# Time-varying strata/age groups cox regression
coxreg_agestrata <- df_comorb_chapters %>%
  anti_join(chapters_age_filter, by="comorb") %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, sex, byear) %>%
  nest(-comorb) %>%
  mutate(
    data=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ ., data=.x,
                              event="dxevent", cut=c(5.99999, 11.99999), 
                              episode="timegroup")),
    data=map(data, ~mutate(.x, timegroup=factor(timegroup,
                                                levels=c(2,1,3)))), # re-level factor variable for correct comparisons: 0-6 years vs. 6-12 years; 12-18 years vs. 6-12 years
    coxmod=map(data, ~coxph(Surv(tstart, age.at.diag, dxevent) ~
                              survival::strata(timegroup):(caseAC+sex+byear),
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95,
                                  exponentiate=TRUE)),
    coxmod_HRcomp=map(data, ~coxph(Surv(tstart, age.at.diag, dxevent) ~
                                     survival::strata(timegroup)*(caseAC+sex+byear),
                                   cluster=pair_id, data=.x)),
    tidy_coxmod_HRcomp=map(coxmod_HRcomp, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                                exponentiate=TRUE)))

coxreg_agestrata_perage <- coxreg_agestrata %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  filter(!str_detect(term, "sex")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_agestrata_perage %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - ICD chapters: Cox regression (adjusted for sex and birth year) 
               age group stratified/time-varying") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

# Post-hoc comparison of HRs from age-stratified model
coxreg_agestrata_compage <- coxreg_agestrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup() 

coxreg_agestrata_compage %>%
  #arrange(p.value) %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - ICD chapters: Cox regression (adjusted for sex and birth year) 
               age group stratified/time-varying - 
               Compare HRs for groups 0-6 years vs. 6-12 years and 6-12 years vs. 12-18 years") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### MS: Absolute risks/cumulative incidence (Follow-up analysis to Main analysis 1)

```{r absriskchapterssample, message=FALSE, warning=FALSE, results="asis"}
set.seed(1000) # set seed to always get the same results

df_crit_distinct_prematch <- df_crit_distinct %>% 
  dplyr::select(twin_id, pair_id, caseAC, sex, byear)


matchdata <- matchit(formula=caseAC~sex+byear, data=df_crit_distinct_prematch, 
                     method="exact")

# Randomly select a specified # of controls per matched individual
sample_1_0 <- data.frame(subclass=matchdata$subclass, df_crit_distinct_prematch)[!is.na(matchdata$subclass),] 

# Combine subclass variable and data set
sample_1_0 <- sample_1_0[order(sample_1_0$subclass),] # orders data set by subclass

# Separate exposed and unexposed individuals
sample_1 <- sample_1_0[sample_1_0$caseAC==1,] # data set with exposed individuals

sample_0 <- sample_1_0[sample_1_0$caseAC==0,] # data set with unexposed individuals

# Draw 10 people from the unexposed group per individual in the exposed group
nrdraw=10
sample <- getdata(sample_0, sampling::strata(sample_0, stratanames="subclass",
                                             size=nrdraw*c(table(sample_1$subclass)),
                                             method="srswor")) # Stratified sampling from sampling library, checks number of levels in control data set, and takes 10 times number of people in sample_1 data set; table(sample_1$subclass) - distribution; everyone with same pattern of covariates and then match 10 times the amount of people; getdata to get the actual values
sample <- sample[,!(names(sample)%in%c("ID_unit","Prob","Stratum"))]
df_crit_distinct_matched <- rbind(sample_1,sample)

df_crit_distinct_matched <- df_crit_distinct_matched[order(df_crit_distinct_matched$subclass),]
```

## ICD Diagnoses/Conditions

### MS: Crude model (Main analysis 1)

```{r coxdiagnosesbase, message=FALSE, warning=FALSE, results="asis"}
coxreg_diagnoses_base <- df_comorb_diagnoses %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, sex, byear) %>%
  nest(-comorb) %>%
  mutate(
    coxmod=map(data, ~coxph(Surv(age.at.diag, dxevent) ~ caseAC + sex + byear,
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                  exponentiate=TRUE))) %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_diagnoses_base %>%
  filter(term=="caseAC") %>%
  #arrange(desc(estimate)) %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="MS - ICD diagnoses: Cox regression base (adjusted for sex and birth year)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10") #%>%
  #row_spec(which(coxreg_base$term=="caseAC"), background=grey(0.75), bold=TRUE)
```

#### SM: Sex strata (Supplementary analysis 1)

```{r coxdiagnosessexstrata, message=FALSE, warning=FALSE, results="asis"}
diagnoses_sex_filter <- df_comorb_diagnoses %>%
  group_by(comorb, caseAC, sex) %>%
  count(dxevent) %>%
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>%
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>%
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)

barplotdata_diagnoses_sex <- df_comorb_diagnoses %>%
  anti_join(diagnoses_sex_filter, by="comorb") %>%  
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(sex=factor(sex, levels=c(0,1), labels=c("m", "f"))) %>% 
  group_by(comorb, caseAC, sex) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%  
  ungroup() %>%
  filter(dxevent==1) %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  dplyr::select(chind, label, caseAC, sex, n, perc, perc_f)

barplotdata_diagnoses_sex %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Overview ICD diagnoses: N of events per sex") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


# Sex differences
coxreg_diagnoses_sexstrata <- df_comorb_diagnoses %>%
  anti_join(diagnoses_sex_filter, by="comorb") %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, byear, sex) %>%
  nest(-comorb) %>%
  mutate(
    coxmod=map(data, ~coxph(Surv(age.at.diag, dxevent) ~ 
                              survival::strata(factor(sex)):(caseAC+byear),
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                  exponentiate=TRUE)),
    coxmod_HRcomp=map(data, ~coxph(Surv(age.at.diag, dxevent) ~
                                     survival::strata(factor(sex))*(caseAC+byear),
                                   cluster=pair_id, data=.x)),
    tidy_coxmod_HRcomp=map(coxmod_HRcomp, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                                exponentiate=TRUE)))

coxreg_diagnoses_sexstrata_persex <- coxreg_diagnoses_sexstrata %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_diagnoses_sexstrata_persex %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - ICD diagnoses: Cox regression (adjusted for birth year) sex stratified") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

## Sex differences: compare HRs
coxreg_diagnoses_sexstrata_compsex <- coxreg_diagnoses_sexstrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup() 

coxreg_diagnoses_sexstrata_compsex %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  #arrange(p.value) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3))))  %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - ICD diagnoses: Cox regression (adjusted for birth year) sex stratified - Compare HRs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

#### SM: Time/age group varying model (Supplementary analysis 1)

```{r coxdiagnosesagestrata, message=FALSE, warning=FALSE, results="asis"}
diagnoses_age_filter <- df_comorb_diagnoses %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, byear) %>%
  nest(-comorb) %>%
  mutate(
  data_timevar=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ ., data=.x,
                                      event="dxevent", cut=c(5.99999, 11.99999), 
                                      episode="timegroup"))) %>%
  dplyr::select(-data) %>%
  unnest(data_timevar) %>%
  group_by(comorb, caseAC, timegroup) %>%
  count(dxevent) %>%
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>%
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>%
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)

barplotdata_diagnoses_age <- df_comorb_diagnoses %>%
  anti_join(diagnoses_age_filter, by="comorb") %>%  
  nest(-comorb) %>%
  mutate(
  data_timevar=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ ., data=.x,
                                      event="dxevent", cut=c(5.99999, 11.99999), 
                                      episode="timegroup"))) %>%
  dplyr::select(-data) %>%
  unnest(data_timevar) %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(timegroup=factor(timegroup, levels=c(1,2,3), labels=c("0to6", "6to12", "12to18"))) %>% 
  group_by(comorb, caseAC, timegroup) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%  
  ungroup() %>%
  filter(dxevent==1) %>% 
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  dplyr::select(chind, label, caseAC, timegroup, n, perc, perc_f)
  
barplotdata_diagnoses_age %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Overview ICD diagnoses: N of events per age group") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


# Time-varying strata/age groups
coxreg_diagnoses_agestrata <- df_comorb_diagnoses %>%
  anti_join(diagnoses_age_filter, by="comorb") %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, sex, byear) %>%
  nest(-comorb) %>%
  mutate(
    data=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ ., data=.x,
                              event="dxevent", cut=c(5.99999, 11.99999), 
                              episode="timegroup")),
    data=map(data, ~mutate(.x, timegroup=factor(timegroup, levels=c(2,1,3)))),
    coxmod=map(data, ~coxph(Surv(tstart, age.at.diag, dxevent) ~
                              survival::strata(timegroup):(caseAC+sex+byear),
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                  exponentiate=TRUE)),
    coxmod_HRcomp=map(data, ~coxph(Surv(tstart, age.at.diag, dxevent) ~
                                     survival::strata(timegroup)*(caseAC+sex+byear),
                                   cluster=pair_id, data=.x)),
    tidy_coxmod_HRcomp=map(coxmod_HRcomp, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                                exponentiate=TRUE)))

coxreg_diagnoses_agestrata_perage <- coxreg_diagnoses_agestrata %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  filter(!str_detect(term, "sex")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_diagnoses_agestrata_perage %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3))))  %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - ICD diagnoses: Cox regression (adjusted for sex and birth year) 
               age group stratified/time-varying") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


# Post-hoc comparison of HRs from age-stratified model
coxreg_diagnoses_agestrata_compage <- coxreg_diagnoses_agestrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_diagnoses_agestrata_compage %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  #arrange(p.value) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - ICD diagnoses: Cox regression (adjusted for sex and birth year) age group stratified/time-varying - Compare HRs for groups 0-6 years vs. 6-12 years and 6-12 years vs. 12-18 years") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

## Grouped Conditions (across ICD chapters)

### MS: Crude model (Main analysis 1)

```{r coxGroupedConditionsbase, message=FALSE, warning=FALSE, results="asis"}
coxreg_disordergroups_base <- df_comorb_disordergroups %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, sex, byear) %>%
  nest(-comorb) %>%
  mutate(
    coxmod=map(data, ~coxph(Surv(age.at.diag, dxevent) ~ caseAC + sex + byear,
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                  exponentiate=TRUE))) %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_disordergroups_base %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="MS - Condition groups: Cox regression base (adjusted for sex and birth year)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10") #%>%
  #row_spec(which(coxreg_base$term=="caseAC"), background=grey(0.75), bold=TRUE)
```

#### SM: Sex strata (Supplementary analysis 1)

```{r coxGroupedConditionssexstrata, message=FALSE, warning=FALSE, results="asis"}
disordergroups_sex_filter <- df_comorb_disordergroups %>%
  group_by(comorb, caseAC, sex) %>%
  count(dxevent) %>%
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>%
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>%
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)

barplotdata_disordergroups_sex <- df_comorb_disordergroups %>%
  anti_join(disordergroups_sex_filter, by="comorb") %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(sex=factor(sex, levels=c(0,1), labels=c("m", "f"))) %>% 
  group_by(comorb, caseAC, sex) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%  
  ungroup() %>%
  filter(dxevent==1) %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  dplyr::select(chind, label, caseAC, sex, n, perc, perc_f)
  
barplotdata_disordergroups_sex %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Overview Condition groups: N of events per sex") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


# Sex differences
coxreg_disordergroups_sexstrata <- df_comorb_disordergroups %>%
  anti_join(disordergroups_sex_filter, by="comorb") %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, byear, sex) %>%
  nest(-comorb) %>%
  mutate(
    coxmod=map(data, ~coxph(Surv(age.at.diag, dxevent) ~ 
                              survival::strata(factor(sex)):(caseAC+byear),
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                  exponentiate=TRUE)),
    coxmod_HRcomp=map(data, ~coxph(Surv(age.at.diag, dxevent) ~
                                     survival::strata(factor(sex))*(caseAC+byear),
                                   cluster=pair_id, data=.x)),
    tidy_coxmod_HRcomp=map(coxmod_HRcomp, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                                exponentiate=TRUE)))

coxreg_disordergroups_sexstrata_persex <- coxreg_disordergroups_sexstrata %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_disordergroups_sexstrata_persex %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Condition groups: Cox regression (adjusted for birth year) sex stratified") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

## Sex differences: compare HRs
coxreg_disordergroups_sexstrata_compsex <- coxreg_disordergroups_sexstrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_disordergroups_sexstrata_compsex %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  #arrange(p.value) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Condition groups: Cox regression (adjusted for birth year) sex stratified - Compare HRs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

#### SM: Time/age group varying model (Supplementary analysis 1)

```{r coxGroupedConditionsagestrata, message=FALSE, warning=FALSE, results="asis"}
disordergroups_age_filter <- df_comorb_disordergroups %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, byear) %>%
  nest(-comorb) %>%
  mutate(
  data_timevar=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ ., data=.x,
                                      event="dxevent", cut=c(5.99999, 11.99999), 
                                      episode="timegroup"))) %>%
  dplyr::select(-data) %>%
  unnest(data_timevar) %>%
  group_by(comorb, caseAC, timegroup) %>%
  count(dxevent) %>%
  mutate(flag01=ifelse(n()<2, TRUE, FALSE)) %>%
  mutate(flag02=ifelse(n<5, TRUE, FALSE)) %>%
  mutate(flag=ifelse(flag01==TRUE | flag02==TRUE, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(flag==TRUE) %>%
  distinct(comorb)


barplotdata_disordergroups_age <- df_comorb_disordergroups %>%
  anti_join(disordergroups_age_filter, by="comorb") %>%  
  nest(-comorb) %>%
  mutate(
  data_timevar=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ ., data=.x,
                                      event="dxevent", cut=c(5.99999, 11.99999), 
                                      episode="timegroup"))) %>%
  dplyr::select(-data) %>%
  unnest(data_timevar) %>%
  mutate(caseAC=factor(caseAC, levels=c(0,1), labels=c("Controls", "ARFID"))) %>%  
  mutate(timegroup=factor(timegroup, levels=c(1,2,3), labels=c("0to6", "6to12", "12to18"))) %>% 
  group_by(comorb, caseAC, timegroup) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%  
  ungroup() %>%
  filter(dxevent==1) %>% 
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  dplyr::select(chind, label, caseAC, timegroup, n, perc, perc_f)
  
barplotdata_disordergroups_age  %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Overview Condition groups: N of events per age group") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


# Time-varying strata/age groups
coxreg_disordergroups_agestrata <- df_comorb_disordergroups %>%
  anti_join(disordergroups_age_filter, by="comorb") %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, sex, byear) %>%
  nest(-comorb) %>%
  mutate(
    data=map(data, ~survSplit(Surv(age.at.diag, dxevent) ~ ., data=.x,
                              event="dxevent", cut=c(5.99999, 11.99999), 
                              episode="timegroup")),
    data=map(data, ~mutate(.x, timegroup=factor(timegroup, levels=c(2,1,3)))),
    coxmod=map(data, ~coxph(Surv(tstart, age.at.diag, dxevent) ~
                              survival::strata(timegroup):(caseAC+sex+byear),
                            cluster=pair_id, data=.x)),
    tidy_coxmod=map(coxmod, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                  exponentiate=TRUE)),
    coxmod_HRcomp=map(data, ~coxph(Surv(tstart, age.at.diag, dxevent) ~
                                     survival::strata(timegroup)*(caseAC+sex+byear),
                                   cluster=pair_id, data=.x)),
    tidy_coxmod_HRcomp=map(coxmod_HRcomp, ~tidy(.x, conf.int=TRUE, conf.level=0.95, 
                                                exponentiate=TRUE)))

coxreg_disordergroups_agestrata_perage <- coxreg_disordergroups_agestrata %>%
  unnest(tidy_coxmod) %>%
  filter(!str_detect(term, "byear")) %>%
  filter(!str_detect(term, "sex")) %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup() 

coxreg_disordergroups_agestrata_perage %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Condition groups: Cox regression (adjusted for sex and birth year) 
               age group stratified/time-varying") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


# Post-hoc comparison of HRs from age-stratified model
coxreg_disordergroups_agestrata_compage <- coxreg_disordergroups_agestrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  group_by(term) %>%
  mutate(q=p.adjust(p.value, method="BH")) %>%
  ungroup()

coxreg_disordergroups_agestrata_compage %>%
  mutate(sig=as.character(asterisk_function(p.value))) %>%
  #arrange(p.value) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(q=ifelse(q<0.0001, "<0.0001", 
                          ifelse(q<0.001,
                                 formatC(q, format="f", digits=4),
                                 formatC(q, format="f", digits=3)))) %>%
  mutate(across(c(estimate, std.error, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>%
  dplyr::select(comorb, term, estimate, std.error, robust.se,
                statistic, p.value, conf.low, conf.high, sig) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Condition groups: Cox regression (adjusted for sex and birth year) 
               age group stratified/time-varying - Compare HRs for groups 0-6 years vs. 6-12 years and 6-12 years vs. 12-18 years") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

# Number of distinct diagnoses/conditions

## MS: Overall number of distinct diagnoses (Main analysis 2)

```{r distinctDx, message=FALSE, warning=FALSE, results="asis"}
df_comorb_distinctDx <- df_comorb_all %>%
  mutate(ind=ifelse(is.na(Diagnos) | (age.at.diag>=18), 0, 1)) %>%
  group_by(twin_id) %>% 
  mutate(distinctDx=length(unique(Diagnos[ind==1]))) %>%
  ungroup() %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>% # Filter age below 18 years
  dplyr::select(twin_id, pair_id, distinctDx, caseAC, sex, byear, age.at.end.of.followup) %>%
  mutate(byear=factor(byear),
         sex_fctr=factor(sex, labels=c("male", "female")),
         Group=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls")))

df_comorb_distinctDx %>%
  #group_by(Group) %>%
  rstatix::get_summary_stats(age.at.end.of.followup) %>%
  dplyr::select(n, mean, sd) %>%
  knitr::kable(format="html", align="l", digits=3,
               caption="Summary statistics for age at end of follow-up") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")



# Check data set completeness
#df_comorb_distinctDx %>% count(caseAC)
#df_crit_distinct %>% count(caseAC)


df_comorb_distinctDx %>%
  group_by(Group) %>%
  summarize(mean_distinctDx=mean(distinctDx, na.rm=TRUE), 
            sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="MS - Overview: Number of distinct diagnoses") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

distinctDx_desc <- df_comorb_distinctDx %>%
  group_by(Group) %>%
  mutate(mean_distinctDx=mean(distinctDx, na.rm=TRUE),
         sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(Group, sex_fctr) %>%
  mutate(mean_distinctDx_sex=mean(distinctDx, na.rm=TRUE),
         sem_distinctDx_sex=std.error(distinctDx, na.rm=TRUE)) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(Group, sex_fctr, contains("mean_"), contains("sem_"))

# Poisson regressions
glm_distinctDx <- glm(distinctDx ~ offset(log(age.at.end.of.followup)) + caseAC + sex + byear,
            family=poisson(link="log"),
            na.action=na.omit,
            data=df_comorb_distinctDx)


vcov_glm_distinctDx <- vcovCL(x=glm_distinctDx, 
                              cluster=df_comorb_distinctDx$pair_id)

glm_distinctDx_cluster <- as_tibble(cbind(glm_distinctDx$coef, 
                                          sqrt(diag(vcov_glm_distinctDx))), 
                                    rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
        confint.high=base::exp(confint.high))

glm_distinctDx_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC")) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overall number of distinct diagnoses 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### SM: Overall number of distinct diagnoses - sex differences (Supplementary analysis 3)

```{r sexdiffdistinctDx, message=FALSE, warning=FALSE, results="asis"}
df_comorb_distinctDx %>%
  group_by(Group, sex_fctr) %>%
  summarize(mean_distinctDx=mean(distinctDx, na.rm=TRUE), 
            sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="SM - Overview: Number of distinct diagnoses per sex") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


glm_distinctDx_sex <- glm(distinctDx ~ offset(log(age.at.end.of.followup)) + caseAC*sex + byear,
            family=poisson(link="log"),
            na.action=na.omit,
            data=df_comorb_distinctDx)

vcov_glm_distinctDx_sex <- vcovCL(x=glm_distinctDx_sex, 
                              cluster=df_comorb_distinctDx$pair_id)

glm_distinctDx_sex_cluster <- as_tibble(cbind(glm_distinctDx_sex$coef, 
                                          sqrt(diag(vcov_glm_distinctDx_sex))), 
                                    rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
        confint.high=base::exp(confint.high))

glm_distinctDx_sex_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overall number of distinct diagnoses 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs, including case:sex interaction") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


## MS: Number of distinct mental diagnoses (Main analysis 2)

```{r distinctDxmental, message=FALSE, warning=FALSE, results="asis"}
df_comorb_distinctDx_mental <- df_comorb_all %>%
  mutate(ind=ifelse(is.na(comorb_mental) | (age.at.diag>=18), 0, 1)) %>%
  group_by(twin_id) %>% 
  mutate(distinctDx=length(unique(Diagnos[ind==1]))) %>%
  ungroup() %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>% # Filter age below 18 years
  dplyr::select(twin_id, pair_id, distinctDx, caseAC, sex, byear, age.at.end.of.followup) %>%
  mutate(byear=factor(byear),
         sex_fctr=factor(sex, labels=c("male", "female")),
         Group=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls")))

df_comorb_distinctDx_mental %>%
  group_by(Group) %>%
  summarize(mean_distinctDx=mean(distinctDx, na.rm=TRUE), 
            sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Number of distinct mental diagnoses") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

distinctDx_mental_desc <- df_comorb_distinctDx_mental %>%
  group_by(Group) %>%
  mutate(mean_distinctDx=mean(distinctDx, na.rm=TRUE),
         sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(Group, sex_fctr) %>%
  mutate(mean_distinctDx_sex=mean(distinctDx, na.rm=TRUE),
         sem_distinctDx_sex=std.error(distinctDx, na.rm=TRUE)) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(Group, sex_fctr, contains("mean_"), contains("sem_"))

# Poisson regressions
glm_distinctDx_mental <- glm(distinctDx ~ offset(log(age.at.end.of.followup)) + 
                                caseAC + sex + byear,
            family=poisson(link="log"),
            na.action=na.omit,
            data=df_comorb_distinctDx_mental)

vcov_glm_distinctDx_mental <- vcovCL(x=glm_distinctDx_mental, 
                                          cluster=df_comorb_distinctDx_mental$pair_id)

glm_distinctDx_mental_cluster <- as_tibble(cbind(glm_distinctDx_mental$coef,
                                                      sqrt(diag(vcov_glm_distinctDx_mental))), 
                                                rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
        confint.high=base::exp(confint.high))

glm_distinctDx_mental_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC")) %>%
  knitr::kable(format="html", align="l", digits=4,
               caption="Number of distinct mental diagnoses/conditions 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### SM: Number of distinct mental diagnoses - sex differences (Supplementary analysis 3)

```{r sexdiffdistinctDxmental, message=FALSE, warning=FALSE, results="asis"}
df_comorb_distinctDx_mental %>%
  group_by(Group, sex_fctr) %>%
  summarize(mean_distinctDx=mean(distinctDx, na.rm=TRUE), 
            sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Number of distinct mental diagnoses per sex") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


glm_distinctDx_mental_sex <- glm(distinctDx ~ offset(log(age.at.end.of.followup)) + caseAC*sex + byear,
            family=poisson(link="log"),
            na.action=na.omit,
            data=df_comorb_distinctDx_mental)

vcov_glm_distinctDx_mental_sex <- vcovCL(x=glm_distinctDx_mental_sex, 
                              cluster=df_comorb_distinctDx_mental$pair_id)

glm_distinctDx_mental_sex_cluster <- as_tibble(cbind(glm_distinctDx_mental_sex$coef, 
                                          sqrt(diag(vcov_glm_distinctDx_mental_sex))), 
                                    rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
        confint.high=base::exp(confint.high))

glm_distinctDx_mental_sex_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Number of distinct mental diagnoses/conditions (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs, including case:sex interaction") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

## MS: Number of distinct somatic diagnoses (Main analysis 2)

```{r distinctDxsomatic, message=FALSE, warning=FALSE, results="asis"}
df_comorb_distinctDx_somatic <- df_comorb_all %>%
  mutate(ind=ifelse(is.na(comorb_somatic) | (age.at.diag>=18), 0, 1)) %>%
  group_by(twin_id) %>% 
  mutate(distinctDx=length(unique(Diagnos[ind==1]))) %>%
  ungroup() %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>% 
  dplyr::select(twin_id, pair_id, distinctDx, caseAC, sex, byear, age.at.end.of.followup) %>%
  mutate(byear=factor(byear),
         sex_fctr=factor(sex, labels=c("male", "female")),
         Group=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls")))

df_comorb_distinctDx_somatic %>%
  group_by(Group) %>%
  summarize(mean_distinctDx=mean(distinctDx, na.rm=TRUE), 
            sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Number of distinct somatic diagnoses") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

distinctDx_somatic_desc <- df_comorb_distinctDx_somatic %>%
  group_by(Group) %>%
  mutate(mean_distinctDx=mean(distinctDx, na.rm=TRUE),
         sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(Group, sex_fctr) %>%
  mutate(mean_distinctDx_sex=mean(distinctDx, na.rm=TRUE),
         sem_distinctDx_sex=std.error(distinctDx, na.rm=TRUE)) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(Group, sex_fctr, contains("mean_"), contains("sem_"))

# Poisson regressions
glm_distinctDx_somatic <- glm(distinctDx ~ offset(log(age.at.end.of.followup)) + 
                                caseAC + sex + byear,
            family=poisson(link="log"),
            na.action=na.omit,
            data=df_comorb_distinctDx_somatic)

vcov_glm_distinctDx_somatic <- vcovCL(x=glm_distinctDx_somatic, 
                                      cluster=df_comorb_distinctDx_somatic$pair_id)

glm_distinctDx_somatic_cluster <- as_tibble(cbind(glm_distinctDx_somatic$coef,
                                                  sqrt(diag(vcov_glm_distinctDx_somatic))), 
                                            rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
        confint.high=base::exp(confint.high))

glm_distinctDx_somatic_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC")) %>%
  knitr::kable(format="html", align="l", digits=4,
               caption="Number of distinct somatic diagnoses/conditions 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### SM: Number of distinct somatic diagnoses - sex differences (Supplementary analysis 3)

```{r sexdiffdistinctDxsomatic, message=FALSE, warning=FALSE, results="asis"}
df_comorb_distinctDx_somatic %>%
  group_by(Group, sex_fctr) %>%
  summarize(mean_distinctDx=mean(distinctDx, na.rm=TRUE), 
            sem_distinctDx=std.error(distinctDx, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Number of distinct somatic diagnoses per sex") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


glm_distinctDx_somatic_sex <- glm(distinctDx ~ offset(log(age.at.end.of.followup)) + caseAC*sex + byear,
            family=poisson(link="log"),
            na.action=na.omit,
            data=df_comorb_distinctDx_somatic)

vcov_glm_distinctDx_somatic_sex <- vcovCL(x=glm_distinctDx_somatic_sex, 
                              cluster=df_comorb_distinctDx_somatic$pair_id)

glm_distinctDx_somatic_sex_cluster <- as_tibble(cbind(glm_distinctDx_somatic_sex$coef, 
                                          sqrt(diag(vcov_glm_distinctDx_somatic_sex))), 
                                    rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
        confint.high=base::exp(confint.high))

glm_distinctDx_somatic_sex_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Number of distinct somatic diagnoses/conditions (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs, including case:sex interaction") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


# Duration of inpatient treatment

## MS: Duration of inpatient treatment due to any diagnosis (Main analysis 3)

```{r inpatTx, message=FALSE, warning=FALSE, results="asis"}
df_comorb_inpatTx <- df_comorb_all %>%
  mutate(ind=ifelse(is.na(source), 0, 
                    ifelse((source=="Inpatient") & (age.at.diag<18), 1, 0))) %>%
  mutate(inpat_dur=ifelse(ind==1, vtid, 0)) %>% # in days
  group_by(twin_id, age.at.diag) %>% # Filter "just" 1 hospitalization at the same age
  slice_max(inpat_dur, n=1) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  group_by(twin_id) %>%
  mutate(sum_inpat_dur=sum(inpat_dur, na.rm=TRUE)) %>%
  ungroup() %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>%
  dplyr::select(twin_id, pair_id, sum_inpat_dur, caseAC, sex, 
                byear, age.at.end.of.followup) %>%
  mutate(byear=factor(byear),
         sex_fctr=factor(sex, labels=c("male", "female")),
         Group=factor(caseAC, labels=c("Controls", "ARFID")))
  
df_comorb_inpatTx %>%
  group_by(Group) %>%
  summarize(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
            sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Overall inpatient treatment duration due to any diagnosis (in days)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

inpatTx_desc <- df_comorb_inpatTx %>%
  group_by(Group) %>%
  mutate(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
         sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(Group, sex_fctr) %>%
  mutate(mean_inpatTx_sex=mean(sum_inpat_dur, na.rm=TRUE), 
         sem_inpatTx_sex=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(Group, sex_fctr, contains("mean_"), contains("sem_"))

# Poisson regressions
glm_inpatTx <- glm(sum_inpat_dur ~ offset(log(age.at.end.of.followup)) + 
                     caseAC + sex + byear,
                   family=poisson(link="log"),
                   na.action=na.omit,
                   data=df_comorb_inpatTx)

vcov_glm_inpatTx <- vcovCL(x=glm_inpatTx, 
                           cluster=df_comorb_inpatTx$pair_id)

glm_inpatTx_cluster <- as_tibble(cbind(glm_inpatTx$coef, sqrt(diag(vcov_glm_inpatTx))), 
                                 rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
         confint.high=base::exp(confint.high))

glm_inpatTx_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC")) %>%
  knitr::kable(format="html", align="l", digits=4,
               caption="Overall inpatient treatment duration due to any diagnosis 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


### SM: Duration of inpatient treatment due to any diagnosis - sex differences (Supplementary analysis 4)

```{r sexdiffinpatTx, message=FALSE, warning=FALSE, results="asis"}
df_comorb_inpatTx %>%
  group_by(Group, sex_fctr) %>%
  summarize(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
            sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Overall inpatient treatment duration due to any diagnosis per sex (in days)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


glm_inpatTx_sex <- glm(sum_inpat_dur ~ offset(log(age.at.end.of.followup)) + 
                     caseAC*sex + byear,
                   family=poisson(link="log"),
                   na.action=na.omit,
                   data=df_comorb_inpatTx)

vcov_glm_inpatTx_sex <- vcovCL(x=glm_inpatTx_sex, 
                           cluster=df_comorb_inpatTx$pair_id)

glm_inpatTx_sex_cluster <- as_tibble(cbind(glm_inpatTx_sex$coef, 
                                           sqrt(diag(vcov_glm_inpatTx_sex))), 
                                 rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
         confint.high=base::exp(confint.high))

glm_inpatTx_sex_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  knitr::kable(format="html", align="l", digits=4,
               caption="Overall inpatient treatment duration due to any diagnosis 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs, including case:sex interaction") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

## MS: Duration of inpatient treatment due to any mental diagnosis (Main analysis 3)

```{r inpatTxmental, message=FALSE, warning=FALSE, results="asis"}
df_comorb_inpatTx_mental <- df_comorb_all %>%
  mutate(ind=ifelse(is.na(source), 0, 
                    ifelse(!is.na(comorb_mental) & 
                             (Diag_nr=="dia1") & # Only main diagnosis is analyzed: Dia 1
                             (source=="Inpatient") & 
                             (age.at.diag<18), 1, 0))) %>%
  mutate(inpat_dur=ifelse(ind==1, vtid, 0)) %>% # in days
  group_by(twin_id, age.at.diag) %>% # Filter "just" 1 hospitalization at the same age
  slice_max(inpat_dur, n=1) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  group_by(twin_id) %>%
  mutate(sum_inpat_dur=sum(inpat_dur, na.rm=TRUE)) %>%
  ungroup() %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>%
  dplyr::select(twin_id, pair_id, sum_inpat_dur, caseAC, sex, byear, age.at.end.of.followup) %>%
  mutate(byear=factor(byear),
         sex_fctr=factor(sex, labels=c("male", "female")),
         Group=factor(caseAC, labels=c("Controls", "ARFID")))

df_comorb_inpatTx_mental %>%
  group_by(Group) %>%
  summarize(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
            sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Inpatient treatment duration due to any mental diagnosis (in days)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

inpatTx_mental_desc <- df_comorb_inpatTx_mental %>%
  group_by(Group) %>%
  mutate(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
         sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(Group, sex_fctr) %>%
  mutate(mean_inpatTx_sex=mean(sum_inpat_dur, na.rm=TRUE), 
         sem_inpatTx_sex=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(Group, sex_fctr, contains("mean_"), contains("sem_"))

# Poisson regressions
glm_inpatTx_mental <- glm(sum_inpat_dur ~ offset(log(age.at.end.of.followup)) + 
                                 caseAC + sex + byear,
            family=poisson(link="log"),
            na.action=na.omit,
            data=df_comorb_inpatTx_mental)

vcov_glm_inpatTx_mental <- vcovCL(x=glm_inpatTx_mental, 
                                       cluster=df_comorb_inpatTx_mental$pair_id)

glm_inpatTx_mental_cluster <- as_tibble(cbind(glm_inpatTx_mental$coef, 
                                                   sqrt(diag(vcov_glm_inpatTx_mental))),
          rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
         confint.high=base::exp(confint.high)) 

glm_inpatTx_mental_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC")) %>%
  knitr::kable(format="html", align="l", digits=4,
               caption="Inpatient treatment duration due to mental diagnosis 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### SM: Duration of inpatient treatment due to any mental diagnosis - sex differences (Supplementary analysis 4)

```{r sexdiffinpatTxmental, message=FALSE, warning=FALSE, results="asis"}
df_comorb_inpatTx_mental %>%
  group_by(Group, sex_fctr) %>%
  summarize(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
            sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE))  %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Inpatient treatment duration due to any 
               mental diagnosis per sex (in days)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


glm_inpatTx_mental_sex <- glm(sum_inpat_dur ~ offset(log(age.at.end.of.followup)) + 
                     caseAC*sex + byear,
                   family=poisson(link="log"),
                   na.action=na.omit,
                   data=df_comorb_inpatTx_mental)

vcov_glm_inpatTx_mental_sex <- vcovCL(x=glm_inpatTx_mental_sex, 
                           cluster=df_comorb_inpatTx_mental$pair_id)

glm_inpatTx_mental_sex_cluster <- as_tibble(cbind(glm_inpatTx_mental_sex$coef, 
                                           sqrt(diag(vcov_glm_inpatTx_mental_sex))), 
                                 rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
         confint.high=base::exp(confint.high))

glm_inpatTx_mental_sex_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  knitr::kable(format="html", align="l", digits=4,
               caption="Inpatient treatment duration due to any mental diagnosis 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs, including case:sex interaction") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


## Duration of inpatient treatment due to any somatic diagnosis (Main analysis 3)

```{r inpatTxsomatic, message=FALSE, warning=FALSE, results="asis"}
df_comorb_inpatTx_somatic <- df_comorb_all %>%
  mutate(ind=ifelse(is.na(source), 0, 
                    ifelse(!is.na(comorb_somatic) & 
                             (Diag_nr=="dia1") & # only look at main diagnosis
                             (source=="Inpatient") & 
                             (age.at.diag<18), 1, 0))) %>%
  mutate(inpat_dur=ifelse(ind==1, vtid, 0)) %>% # in days
  group_by(twin_id, age.at.diag) %>% # Filter "just" 1 hospitalization at the same age
  slice_max(inpat_dur, n=1) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  group_by(twin_id) %>%
  mutate(sum_inpat_dur=sum(inpat_dur, na.rm=TRUE)) %>%
  ungroup() %>%
  distinct(twin_id, .keep_all=TRUE) %>%
  mutate(age.at.end.of.followup_pre=ifelse(!is.na(cens.age), cens.age, age.at.npr.end)) %>%
  mutate(age.at.end.of.followup=ifelse(age.at.end.of.followup_pre>=18, 
                                       17.99999, age.at.end.of.followup_pre)) %>%
  dplyr::select(twin_id, pair_id, sum_inpat_dur, caseAC, sex, byear, age.at.end.of.followup) %>%
  mutate(byear=factor(byear),
         sex_fctr=factor(sex, labels=c("male", "female")),
         Group=factor(caseAC, labels=c("Controls", "ARFID")))

df_comorb_inpatTx_somatic %>%
  group_by(Group) %>%
  summarize(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
            sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Inpatient treatment duration due to any somatic diagnosis (in days)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

inpatTx_somatic_desc <- df_comorb_inpatTx_somatic %>%
  group_by(Group) %>%
  mutate(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
         sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(Group, sex_fctr) %>%
  mutate(mean_inpatTx_sex=mean(sum_inpat_dur, na.rm=TRUE), 
         sem_inpatTx_sex=std.error(sum_inpat_dur, na.rm=TRUE)) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(Group, sex_fctr, contains("mean_"), contains("sem_"))

# Poisson regressions
glm_inpatTx_somatic <- glm(sum_inpat_dur ~ offset(log(age.at.end.of.followup)) + 
                                 caseAC + sex + byear,
            family=poisson(link="log"),
            na.action=na.omit,
            data=df_comorb_inpatTx_somatic)

vcov_glm_inpatTx_somatic <- vcovCL(x=glm_inpatTx_somatic, 
                                       cluster=df_comorb_inpatTx_somatic$pair_id)

glm_inpatTx_somatic_cluster <- as_tibble(cbind(glm_inpatTx_somatic$coef, 
                                                   sqrt(diag(vcov_glm_inpatTx_somatic))),
          rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
         confint.high=base::exp(confint.high)) 

glm_inpatTx_somatic_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC")) %>%
  knitr::kable(format="html", align="l", digits=4,
               caption="Inpatient treatment duration due to any somatic diagnosis 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### SM: Duration of inpatient treatment due to any somatic diagnosis - sex differences (Supplementary analysis 4)

```{r sexdiffinpatTxsomatic, message=FALSE, warning=FALSE, results="asis"}
df_comorb_inpatTx_somatic %>%
  group_by(Group, sex_fctr) %>%
  summarize(mean_inpatTx=mean(sum_inpat_dur, na.rm=TRUE), 
            sem_inpatTx=std.error(sum_inpat_dur, na.rm=TRUE))  %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Overview: Inpatient treatment duration due to any 
               somatic diagnosis per sex (in days)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


glm_inpatTx_somatic_sex <- glm(sum_inpat_dur ~ offset(log(age.at.end.of.followup)) + 
                     caseAC*sex + byear,
                   family=poisson(link="log"),
                   na.action=na.omit,
                   data=df_comorb_inpatTx_somatic)

vcov_glm_inpatTx_somatic_sex <- vcovCL(x=glm_inpatTx_somatic_sex, 
                           cluster=df_comorb_inpatTx_somatic$pair_id)

glm_inpatTx_somatic_sex_cluster <- as_tibble(cbind(glm_inpatTx_somatic_sex$coef, 
                                           sqrt(diag(vcov_glm_inpatTx_somatic_sex))), 
                                 rownames="term") %>%
  mutate(z=V1/V2, p.value=2*pnorm(-abs(z))) %>%
  dplyr::rename(coef=V1, se=V2) %>%
  mutate(confint.low=coef-1.96*se,
         confint.high=coef+1.96*se) %>%
  mutate(coef=base::exp(coef), confint.low=base::exp(confint.low),
         confint.high=base::exp(confint.high))

glm_inpatTx_somatic_sex_cluster %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  knitr::kable(format="html", align="l", digits=4,
               caption="Inpatient treatment duration due to any somatic diagnosis 
               (accounting for offset/exposure time): 
               Clustering/robust sandwich SEs, including case:sex interaction") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

# MS: FDR/BH thresholds (multiple testing adjustment)

```{r MSpthresbenjaminihochberg, message=FALSE, warning=FALSE, results="asis"}
# Base model
pvals_chapters_base <- coxreg_base %>%
  filter(term=="caseAC") %>%
  dplyr::select(p.value)

pvals_diagnoses_base <- coxreg_diagnoses_base %>%
  filter(term=="caseAC") %>%
  dplyr::select(p.value)

pvals_disordergroups_base <- coxreg_disordergroups_base %>%
  filter(term=="caseAC") %>%
  dplyr::select(p.value)

pvals_distinctDx <- bind_rows(glm_distinctDx_cluster, glm_distinctDx_mental_cluster,
                               glm_distinctDx_somatic_cluster) %>%
  filter(term=="caseAC") %>%
  dplyr::select(p.value)

pvals_inpatTx <- bind_rows(glm_inpatTx_cluster, glm_inpatTx_mental_cluster,
                               glm_inpatTx_somatic_cluster) %>%
  filter(term=="caseAC") %>%
  dplyr::select(p.value)

bind_rows(pvals_chapters_base, 
          pvals_diagnoses_base,
          pvals_disordergroups_base,
          pvals_distinctDx,
          pvals_inpatTx) %>% 
  nrow(.) %>%
  knitr::kable(format="html", align="l",
               col.names="N tests",
               caption="Overall number of outcomes") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
  

pvals_MS <- bind_rows(pvals_chapters_base, 
                      pvals_diagnoses_base,
                      pvals_disordergroups_base,
                      pvals_distinctDx,
                      pvals_inpatTx) %>%
  pull(p.value)


get_bh_threshold <- function(pvals, alpha, mtests = length(pvals)){
  m <- length(pvals)
  pvals <- sort(pvals)
  prejected <- which(pvals <= (1:m)/mtests*alpha)
  ifelse(length(prejected)==0, 0, pvals[prejected[which.max(prejected)]])}

pthres_MS <- get_bh_threshold(pvals_MS, 0.05)

pthres_MS %>%
  knitr::kable(format="html", align="l", digits=4,
               col.names="alpha thres",
               caption="Benjamini-Hochberg/FDR p-value threshold (stat. significance)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

asterisk_function_MS <- function(x) {
  ifelse(is.na(x), NA, 
  symnum(x, corr=FALSE, na=FALSE, legend=FALSE,
         cutpoints=c(0, pthres_MS, 1), 
         symbols=c("*", "")))}
```

## SM: FDR/BH thresholds (multiple testing adjustment)

```{r SMpthresbenjaminihochberg, message=FALSE, warning=FALSE, results="asis"}
# Supplementary p-value thresholds

# Sex strata
pvals_chapters_sexstrata <- coxreg_sexstrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  dplyr::select(p.value)

pvals_diagnoses_sexstrata <- coxreg_diagnoses_sexstrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  dplyr::select(p.value)

pvals_disordergroups_sexstrata <- coxreg_disordergroups_sexstrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  dplyr::select(p.value)


# Age strata
pvals_chapters_agestrata <- coxreg_agestrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  dplyr::select(p.value)

pvals_diagnoses_agestrata <- coxreg_diagnoses_agestrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  dplyr::select(p.value)

pvals_disordergroups_agestrata <- coxreg_disordergroups_agestrata %>%
  unnest(tidy_coxmod_HRcomp) %>%
  filter(str_detect(term, "caseAC") & term!="caseAC") %>%
  dplyr::select(p.value)


# Number of distinct diagnoses and inpatient treatment duration - sex effects
pvals_distinctDx_sex <- bind_rows(glm_distinctDx_sex_cluster, glm_distinctDx_mental_sex_cluster,
                               glm_distinctDx_somatic_sex_cluster) %>%
  filter(term=="caseAC:sex") %>%
  dplyr::select(p.value)

pvals_inpatTx_sex <- bind_rows(glm_inpatTx_sex_cluster, glm_inpatTx_mental_sex_cluster,
                               glm_inpatTx_somatic_sex_cluster) %>%
  filter(term=="caseAC:sex") %>%
  dplyr::select(p.value)


bind_rows(pvals_chapters_sexstrata, 
          pvals_diagnoses_sexstrata,
          pvals_disordergroups_sexstrata,
          pvals_chapters_agestrata, 
          pvals_diagnoses_agestrata,
          pvals_disordergroups_agestrata,
          pvals_distinctDx_sex,
          pvals_inpatTx_sex) %>% 
  nrow(.) %>%
  knitr::kable(format="html", align="l",
               col.names="N tests",
               caption="SM: Overall number of supplementary outcomes") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
  

pvals_SM <- bind_rows(pvals_chapters_sexstrata, 
                      pvals_diagnoses_sexstrata,
                      pvals_disordergroups_sexstrata,
                      pvals_chapters_agestrata, 
                      pvals_diagnoses_agestrata,
                      pvals_disordergroups_agestrata,
                      pvals_distinctDx_sex,
                      pvals_inpatTx_sex) %>% 
  pull(p.value)

pthres_SM <- get_bh_threshold(pvals_SM, 0.05)

pthres_SM %>%
  knitr::kable(format="html", align="l", digits=6,
               col.names="alpha thres",
               caption="SM: Benjamini-Hochberg/FDR p-value threshold for SM") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

asterisk_function_SM <- function(x) {
  ifelse(is.na(x), NA, 
  symnum(x, corr=FALSE, na=FALSE, legend=FALSE,
         cutpoints=c(0, pthres_SM, 1), 
         symbols=c("*", "")))}
```


# MS Visualizations

## Settings

```{r figuresettings, message=FALSE, warning=FALSE}
plot_theme_transparent = theme(plot.title = element_text(size=35), 
                   axis.text = element_text(size=35, color="black"), 
                   axis.title = element_text(size=35, color="black"), 
                   axis.line = element_line(color = "black", size=1.75),
                   legend.title = element_text(size=35), 
                   legend.text = element_text(size=32),
                   legend.background = element_rect(fill="white", color="white"),
                   legend.box.background = element_rect(fill="white", color="white"),
                   panel.background = element_rect(fill="white", color="white"), 
                   plot.background = element_rect(fill="white", color="white"), 
                   panel.border = element_blank(),
                   panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank(),
                   strip.text = element_text(size=35, color="black", hjust=0),
                   strip.background = element_rect(color=NA, fill=NA))
```

## Plotdata

```{r barscoxregplotdata, message=FALSE, warning=FALSE}
# HR plot data base model
plot_coxreg_base <- coxreg_base %>%
  filter(term=="caseAC") %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  mutate(p.value_f=ifelse(p.value<0.0001, "<0.0001", ifelse(p.value<0.001,
                                                            formatC(p.value, format="f",
                                                                    digits=4),
                                                            formatC(p.value, format="f",
                                                                    digits=3)))) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  mutate(p.label=ifelse(p.value<0.0001, "p", "p=")) %>% 
  unite("p.plot", c(p.label, p.value_f, sig), sep="", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(chind, label, estimate, conf.low, conf.high, p.value, p.plot, sig)

plot_coxreg_diagnoses_base <- coxreg_diagnoses_base %>%
  filter(term=="caseAC") %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  mutate(p.value_f=ifelse(p.value<0.0001, "<0.0001", ifelse(p.value<0.001,
                                                            formatC(p.value, format="f", digits=4),
                                                            formatC(p.value, format="f", digits=3)))) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  mutate(p.label=ifelse(p.value<0.0001, "p", "p=")) %>% 
  unite("p.plot", c(p.label, p.value_f, sig), sep="", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(chind, label, estimate, conf.low, conf.high, p.value, p.plot, sig)

plot_coxreg_disordergroups_base <- coxreg_disordergroups_base %>%
  filter(term=="caseAC") %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  mutate(p.value_f=ifelse(p.value<0.0001, "<0.0001", ifelse(p.value<0.001,
                                                            formatC(p.value, 
                                                                    format="f", 
                                                                    digits=4),
                                                            formatC(p.value, 
                                                                    format="f", 
                                                                    digits=3)))) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  mutate(p.label=ifelse(p.value<0.0001, "p", "p=")) %>% 
  unite("p.plot", c(p.label, p.value_f, sig), sep="", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(chind, label, estimate, conf.low, conf.high, p.value, p.plot, sig)


hrplotdata <- bind_rows(plot_coxreg_base, plot_coxreg_diagnoses_base,
                        plot_coxreg_disordergroups_base) %>%
  mutate(HR_order=ifelse(label=="EntireChapter", 1000, conf.low))


# Bar plot data
barplotdata_chapters <- df_comorb_chapters %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  mutate(caseAC=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls"))) %>% 
  dplyr::rename(Group=caseAC) %>%
  group_by(comorb, chind, label, Group) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%  
  ungroup() %>%
  filter(dxevent==1) %>%
  left_join(plot_coxreg_base, by=c("chind", "label")) %>%
  mutate(sig=ifelse(Group=="Controls", "", sig)) %>%
  dplyr::select(chind, label, Group, n, perc, perc_f, sig)

barplotdata_diagnoses <- df_comorb_diagnoses %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  mutate(caseAC=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls"))) %>% 
  dplyr::rename(Group=caseAC) %>%
  group_by(comorb, chind, label, Group) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%  
  ungroup() %>%
  filter(dxevent==1) %>%
  left_join(plot_coxreg_diagnoses_base, by=c("chind", "label")) %>%
  mutate(sig=ifelse(Group=="Controls", "", sig)) %>%
  dplyr::select(chind, label, Group, n, perc, perc_f, sig)

barplotdata_disordergroups <- df_comorb_disordergroups %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=FALSE) %>%
  mutate(caseAC=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls"))) %>% 
  dplyr::rename(Group=caseAC) %>%
  group_by(comorb, chind, label, Group) %>%
  count(dxevent) %>%
  mutate(n_total=sum(n))  %>%
  mutate(perc=100*(n/n_total)) %>%
  mutate(perc_f=paste0(ifelse(perc<0.1, "<0.1",
                              formatC(perc, format="f", digits=2)), "%")) %>%
  ungroup() %>%
  filter(dxevent==1) %>%
  left_join(plot_coxreg_disordergroups_base, by=c("chind", "label")) %>%
  mutate(sig=ifelse(Group=="Controls", "", sig)) %>%
  dplyr::select(chind, label, Group, n, perc, perc_f, sig)


barplotdata <- bind_rows(barplotdata_chapters, barplotdata_diagnoses,
                         barplotdata_disordergroups) %>%
  group_by(chind, label) %>%
  mutate(perc_order=ifelse(label=="EntireChapter", 100,
                           ifelse(Group=="ARFID", lead(perc), perc))) %>%
  ungroup()


# Internal data consistency check only
# bind_rows(barplotdata_chapters, barplotdata_diagnoses,
#                          barplotdata_disordergroups) %>%
#   distinct(label, .keep_all=TRUE)
```

## Fig2: Barplots

```{r msbarplots, message=FALSE, warning=FALSE}
# Axis transformation
root <- function(x) x^(7.5/10)
exp <- function(x) x^(10/7.5)
man.trans <- trans_new(name="man_trans",
                       transform=root,
                       inverse=exp)


barplotlist=list()
barplotlegendlist=list()

get_legend <- function(plot){
  tmp <- ggplot_gtable(ggplot_build(plot))
  leg <- which(sapply(tmp$grobs, function(x) x$name)=="guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
  }

for (Chind in unique(barplotdata$chind)) {
  
  plotdata <- barplotdata %>% filter(chind==Chind)
  
  barplots_leg <- ggplot(data=plotdata, aes(x=reorder(label, -perc_order), y=perc, 
                                         group=Group, color=Group, fill=Group)) +
    geom_col(aes(x=reorder(label, -perc_order), y=perc, 
                 group=Group, fill=Group), color=NA,
             stat="identity", position=position_dodge(0.9)) +
    theme(panel.grid.major.y=element_line(color="gray80",
                                          size=1.75,
                                          linetype=1)) +
    scale_fill_manual(values = alpha(c("#AB5E00", "#31439B", "#000000"), 1)) +
    scale_color_manual(values = alpha(c("#AB5E00", "#31439B", "#000000"), 1)) +
    #scale_fill_carto_d(palette="Safe") + scale_color_carto_d(palette="Safe") + 
    #Color blindness accessible, see here: https://stackoverflow.com/questions/57153428/r-plot-color-combinations-that-are-colorblind-accessible
    geom_text(aes(label=perc_f, x=label, y=perc, group=Group, color=Group, fill=Group), 
              position=position_dodge(0.9), vjust=0.45, hjust=-0.08,
              size=10.5, angle=90, fontface="bold") +
    geom_text(aes(label=sig, x=label, y=perc, group=Group, color=Group, fill=Group), 
              position=position_dodge(0.9), vjust=-1.8, hjust=-1,
              size=18, fontface="bold", color="black") +
    ggtitle(Chind) +
    guides(fill=guide_legend(nrow=1, byrow=TRUE),
           color=guide_legend(nrow=1, byrow=TRUE)) +
    plot_theme_transparent +
    theme(plot.margin=unit(c(1,1.5,1,1), "cm"), #t, r, b, l
          axis.title.x=element_blank(),
          axis.title.y=element_text(margin=margin(t=0, r=20, b=0, l=0)),
          axis.text.x=element_text(angle=50, size=33, hjust=1),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(0.35, "cm"),
          axis.ticks.length.y=unit(0.35, "cm"),
          plot.title=element_text(vjust=2.8, size=33#, face="bold"
                                  ))
  
  barplots <- barplots_leg +
    theme(legend.position="none") +
    scale_y_continuous(limits=c(0, 64.5),
                       expand=expansion(mult=c(0, 0.05)),
                       breaks=pretty_breaks(n=8), 
                       labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L),
                       trans=man.trans
                       ) #y axis: Cubic root scaling/transformation applied
  
  barplotlist[[Chind]]=barplots
  barplotlegendlist[[Chind]]=barplots_leg 
  }
 
barplotlegend <- get_legend(barplotlegendlist[[1]])

barplot_E <- barplotlist[[1]] + ylab("Prevalence (%)")
barplot_F <- barplotlist[[2]] + ylab(NULL)
barplot_I <- barplotlist[[3]] + ylab(NULL)
barplot_J <- barplotlist[[4]] + ylab("Prevalence (%)")
barplot_K <- barplotlist[[5]] + ylab(NULL)
barplot_P <- barplotlist[[6]] + ylab(NULL)
barplot_Q <- barplotlist[[7]] + ylab("Prevalence (%)")
barplot_Further <- barplotlist[[8]] + ylab(NULL)
barplot_Groups <- barplotlist[[9]] + ylab(NULL)

barplots1 <- cowplot::plot_grid(barplot_E, barplot_F, barplot_I, nrow=1,
                  align="h", rel_widths=c(6,9,3))
barplots2 <- cowplot::plot_grid(barplot_J, barplot_K, barplot_P, nrow=1,
                  align="h", rel_widths=c(4,8.5,5.5))
barplots3 <- cowplot::plot_grid(barplot_Q, barplot_Further, barplot_Groups, nrow=1,
                  align="h", rel_widths=c(7,8,3))

barplot_arrange <- cowplot::plot_grid(barplotlegend,
                                      barplots1, 
                                      barplots2, 
                                      barplots3, nrow=4,
                                      align="hv", rel_heights=c(1,10,10,10)) +
  theme(plot.background=element_rect(fill="white", color=NA))

#barplot_arrange
                                      
# ggsave(barplot_arrange, path="figures", filename="Figure2_barplots_prevalence.jpeg",
# width=45, height=45, dpi=600)
```

## Fig3: HR plots

```{r mshrplots, message=FALSE, warning=FALSE}
# Axis transformation
root <- function(x) x^(4/5)
exp <- function(x) x^(5/4)
man.trans <- trans_new(name="man_trans",
                       transform=root,
                       inverse=exp)

hrplotlist=list()
#hrplotlegendlist=list()

for (Chind in unique(hrplotdata$chind)) {
  
  plotdata <- hrplotdata %>% filter(chind==Chind)
  
  hrplots <- ggplot(data=plotdata, aes(x=estimate, y=reorder(label, HR_order))) +
    geom_vline(aes(xintercept=1), color="#AB5E00", linetype=3, size=4, alpha=1) +
    geom_errorbarh(aes(xmax=conf.high, xmin=conf.low, height=0.21), color="black", size=2, 
                   linetype="solid") +
    geom_point(aes(x=estimate, y=label),
             color="black", alpha=1, size=5, shape=16) +
    theme(panel.grid.major.x=element_line(color="gray80",
                                          size=1.75,
                                          linetype=1)) +
    geom_text(label="HR=1", color="#AB5E00", x=1, y=-Inf, hjust=-0.06, vjust=-0.26, 
              fontface=4, size=11) +
    ggtitle(Chind) +
    plot_theme_transparent +
    theme(plot.margin=unit(c(1.5,1,1,1), "cm"), #t, r, b, l
        axis.title.y=element_blank(),
        axis.title.x=element_text(margin=margin(t=20, r=0, b=0, l=0)),
        #axis.text.x=element_text(angle=45, hjust=1),
        axis.text.x=element_text(size=31),
        axis.ticks.x=element_line(size=1.75),
        axis.ticks.y=element_line(size=1.75), 
        axis.ticks.length.x=unit(0.35, "cm"),
        axis.ticks.length.y=unit(0.35, "cm"),
        plot.title=element_text(vjust=2.3)) 

  
   if(plotdata$chind=="GroupedConditions") {
     
     hrplots <- hrplots + 
       geom_text(aes(label=p.plot, x=estimate, y=label), vjust=-1.4, hjust=-0.04, size=11) +
       scale_x_continuous(limits=c(0, 22.6),
                     expand=expansion(mult=c(0,0)),
                     breaks=pretty_breaks(n=9),
                     labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L)
                     , trans=man.trans
                     )
     }
  
  if(plotdata$chind!="GroupedConditions") {
    
    hrplots <- hrplots + 
      geom_text(aes(label=p.plot, x=estimate, y=label), vjust=-0.78, hjust=-0.04, size=11) +
      scale_x_continuous(limits=c(0, 22.6),
                     expand=expansion(mult=c(0,0)),
                     breaks=pretty_breaks(n=9),
                     labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L)  
                     , trans=man.trans
                     ) #x axis: cubic root scaling/transformation applied
    }
    
  hrplotlist[[Chind]]=hrplots
  }


hrplot_E <- hrplotlist[[1]] + xlab(NULL) 
hrplot_F <- hrplotlist[[2]] + xlab(NULL) 
hrplot_I <- hrplotlist[[3]] + xlab("HR (95% CI) in ARFID vs. Controls")
hrplot_J <- hrplotlist[[4]] + xlab(NULL) 
hrplot_K <- hrplotlist[[5]] + xlab(NULL)
hrplot_P <- hrplotlist[[6]] + xlab("HR (95% CI) in ARFID vs. Controls")
hrplot_Q <- hrplotlist[[7]] + xlab(NULL)
hrplot_Further <- hrplotlist[[8]] + xlab(NULL)
hrplot_Groups <- hrplotlist[[9]] + xlab("HR (95% CI) in ARFID vs. Controls")

hrplots1 <- cowplot::plot_grid(hrplot_E, hrplot_F, hrplot_I, ncol=1,
                  align="v", rel_heights=c(6,9,3))
hrplots2 <- cowplot::plot_grid(hrplot_J, hrplot_K, hrplot_P, ncol=1,
                  align="v", rel_heights=c(3.75,8.5,5.75))
hrplots3 <- cowplot::plot_grid(hrplot_Q, hrplot_Further, hrplot_Groups, ncol=1,
                  align="v", rel_heights=c(7,8,3))

hrplot_arrange <- cowplot::plot_grid(hrplots1, 
                                     hrplots2, 
                                     hrplots3, ncol=3,
                                     align="h", rel_widths=c(1,1,1)) +
  theme(plot.background=element_rect(fill="white", color=NA))

#hrplot_arrange

# ggsave(hrplot_arrange, path="figures", filename="Figure3_hrplots_relativerisks.jpeg", 
#        width=45, height=45, dpi=600)
```

## Fig4: Cumulative incidence plots

```{r cumincplot, message=FALSE, warning=FALSE}
# root <- function(x) x^(7.5/10)
# exp <- function(x) x^(10/7.5)
# man.trans <- trans_new(name="man_trans",
#                        transform=root,
#                        inverse=exp)


# Cave: Cumulative incidence only for chapters (except for C and P) and Condition groups

cumincplotdata_chapters <- df_crit_distinct_matched %>%
  dplyr::select(twin_id) %>%
  left_join(df_comorb_chapters, by="twin_id") %>%
  filter(!str_detect(comorb, "ChapterP")) %>% # Exclude perinatal conditions
  filter(!str_detect(comorb, "ChapterC")) %>% # Exclude cancer
  separate(comorb, c("chind", "label"), sep="\\.", remove=TRUE) %>%
  mutate(label=chind) %>%
  mutate(caseAC=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls"))) %>% 
  dplyr::rename(Group=caseAC) %>%
  mutate(cuminc_order=0)

cumincplotdata_disordergroups <- df_crit_distinct_matched %>%
  dplyr::select(twin_id) %>%
  left_join(df_comorb_disordergroups, by="twin_id") %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=TRUE) %>%
  mutate(caseAC=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls"))) %>% 
  dplyr::rename(Group=caseAC) %>%
  mutate(cuminc_order=1)

cumincplotdata <- bind_rows(cumincplotdata_chapters, cumincplotdata_disordergroups)  %>%
  arrange(cuminc_order, chind) %>%
  nest(-c(chind, label, cuminc_order)) %>%
  mutate(rn=factor(row_number())) %>%
  mutate(survfit=map(data, ~tidy(survfit(Surv(age.at.diag, dxevent) ~ Group,
                                         cluster=pair_id, data=.x)))) %>%
  unnest(survfit) %>%
  mutate(cumulinc=1-estimate,
           confint.low=1-conf.high,
           confint.high=1-conf.low)


cumincplotlist=list()
cuminclegendlist=list()


for (RN in unique(cumincplotdata$rn)) {
  
  survplotdata <- cumincplotdata %>% filter(rn==RN)
    
  survplot_leg <- ggplot(data=survplotdata, 
                         aes(x=time, y=cumulinc, 
                             ymin=confint.low, 
                             ymax=confint.high, fill=strata)) +
    geom_line(aes(group=strata, color=strata), 
              alpha=1, size=1.75) +
    geom_ribbon(aes(ymin=confint.low, 
                    ymax=confint.high, 
                    group=strata, fill=strata), 
                alpha=0.5, color=NA, outline.type="full") +
    scale_x_continuous(limits=c(0,18), 
                       breaks=c(0,2,4,6,8,10,12,14,16,18),
                       expand=c(0.05,0.1)) +
    scale_y_continuous(limits=c(0,0.61),
                       breaks=pretty_breaks(n=8), 
                       expand=c(0,0),
                       labels=scales::comma_format(scale=100,
                                                   big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L)
                       #, trans=man.trans
                       ) +
    expand_limits(y=0) +
    ggtitle(unique(survplotdata$label)) +
    scale_fill_manual(name="Group", 
                      labels=c("ARFID", "Controls"),
                      values=alpha(c("#AB5E00", "#31439B", "#000000"), 1)) +
    scale_color_manual(name="Group", 
                       labels=c("ARFID", "Controls"),
                       values=alpha(c("#AB5E00", "#31439B", "#000000"), 1)) +
    guides(fill=guide_legend(nrow=1, byrow=TRUE),
           color=guide_legend(nrow=1, byrow=TRUE)) +
    plot_theme_transparent +
    xlab("Age (years)") +
    theme(plot.margin=unit(c(1,1,1,1), "cm"), #t, r, b, l
          axis.title.x=element_text(vjust=-0.4),
          axis.title.y=element_text(vjust=4.5),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(0.35, "cm"),
          axis.ticks.length.y=unit(0.35, "cm"),
          plot.title=element_text(vjust=1.5)) +
    theme(aspect.ratio=57/50)
    
  survplot <- survplot_leg +
    theme(legend.position="none")
 
  cumincplotlist[[RN]]=survplot 
  cuminclegendlist[[RN]]=survplot_leg 
}
 
cumincplotlegend <- get_legend(cuminclegendlist[[1]]) 

cumplot_E <- cumincplotlist[[1]] + ylab("Cumulative incidence (%)")
cumplot_F <- cumincplotlist[[2]] + ylab(NULL)
cumplot_I <- cumincplotlist[[3]] + ylab(NULL)
cumplot_J <- cumincplotlist[[4]] + ylab(NULL)
cumplot_K <- cumincplotlist[[5]] + ylab("Cumulative incidence (%)")
cumplot_Q <- cumincplotlist[[6]] + ylab(NULL)
cumplot_all <- cumincplotlist[[7]] + ylab(NULL)
cumplot_ai <- cumincplotlist[[8]] + ylab(NULL)

cumplots1 <- cowplot::plot_grid(cumplot_E, 
                                cumplot_F, 
                                cumplot_I, 
                                cumplot_J, nrow=1,
                  align="h", rel_widths=c(1,1,1))
cumplots2 <- cowplot::plot_grid(cumplot_K, 
                                cumplot_Q, 
                                cumplot_all, 
                                cumplot_ai, nrow=1,
                  align="h", rel_widths=c(1,1,1))



# Differences in cumulative incidence: ARFID - HC
cumincplotdata_diff <- cumincplotdata %>%
  dplyr::select(rn, chind, label, cuminc_order,
                strata, time, cumulinc,
                confint.low, confint.high)  %>%
  mutate(strata=dplyr::recode(strata,
                              "Group=ARFID"="ARFID",
                              "Group=Controls"="Controls")) %>%
  group_by(rn, chind, label, cuminc_order, strata) %>%
  arrange(time, .by_group=TRUE) %>%
  mutate(time_rounded=round(time, digits=1)) %>%
  group_by(rn, chind, label, cuminc_order, strata, time_rounded) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::select(-time) %>%
  group_by(rn, chind, label, cuminc_order, time_rounded) %>%
  pivot_wider(names_from="strata", values_from=c("cumulinc",
                                                 "confint.low", 
                                                 "confint.high")) %>%
  filter(!is.na(cumulinc_ARFID)&!is.na(cumulinc_Controls)) %>%
  mutate(cumulinc_diff=cumulinc_ARFID-cumulinc_Controls,
         confint.low_diff=confint.low_ARFID-confint.low_Controls,
         confint.high_diff=confint.high_ARFID-confint.high_Controls)


cumincplotlist_diff=list()

for (RN in unique(cumincplotdata_diff$rn)) {
  
  survplotdata_diff <- cumincplotdata_diff %>% filter(rn==RN)
    
  survplot_diff <- ggplot(data=survplotdata_diff, 
                         aes(x=time_rounded, y=cumulinc_diff, 
                             ymin=confint.low_diff, 
                             ymax=confint.high_diff)) +
    geom_line(aes(x=time_rounded, y=cumulinc_diff),
              color="gray50", alpha=1, size=1.75) +
    geom_ribbon(aes(ymin=confint.low_diff, 
                    ymax=confint.high_diff), 
                alpha=0.5, fill="gray50", color=NA, outline.type="full") +
    scale_x_continuous(limits=c(0,18), 
                       breaks=c(0,2,4,6,8,10,12,14,16,18),
                       expand=c(0.05,0.1)) +
    scale_y_continuous(limits=c(-0.02,0.31),
                       breaks=pretty_breaks(n=8), 
                       expand=c(0,0),
                       labels=scales::comma_format(scale=100,
                                                   big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L)
                        #, trans=man.trans
                       ) +
    expand_limits(y=0) +
    ggtitle(unique(survplotdata_diff$label)) +
    plot_theme_transparent +
    xlab("Age (years)") +
    theme(plot.margin=unit(c(1,1,1,1), "cm"), #t, r, b, l
          axis.title.x=element_text(vjust=-0.4),
          axis.title.y=element_text(vjust=4.5),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(0.35, "cm"),
          axis.ticks.length.y=unit(0.35, "cm"),
          plot.title=element_text(vjust=1.5),
          legend.position = "none") +
    theme(aspect.ratio=57/50)
  
  cumincplotlist_diff[[RN]]=survplot_diff 
}

cumplot_diff_E <- cumincplotlist_diff[[1]] + ylab("Difference ARFID - controls (%)")
cumplot_diff_F <- cumincplotlist_diff[[2]] + ylab(NULL)
cumplot_diff_I <- cumincplotlist_diff[[3]] + ylab(NULL)
cumplot_diff_J <- cumincplotlist_diff[[4]] + ylab(NULL)
cumplot_diff_K <- cumincplotlist_diff[[5]] + ylab("Difference ARFID - controls (%)")
cumplot_diff_Q <- cumincplotlist_diff[[6]] + ylab(NULL)
cumplot_diff_all <- cumincplotlist_diff[[7]] + ylab(NULL)
cumplot_diff_ai <- cumincplotlist_diff[[8]] + ylab(NULL)

cumplots_diff1 <- cowplot::plot_grid(cumplot_diff_E, 
                                     cumplot_diff_F, 
                                     cumplot_diff_I, 
                                     cumplot_diff_J, nrow=1,
                  align="h", rel_widths=c(1,1,1))
cumplots_diff2 <- cowplot::plot_grid(cumplot_diff_K, 
                                     cumplot_diff_Q, 
                                     cumplot_diff_all, 
                                     cumplot_diff_ai, nrow=1,
                  align="h", rel_widths=c(1,1,1))


cumincplot_arrange <- cowplot::plot_grid(cumincplotlegend,
                                      cumplots1, 
                                      cumplots_diff1, 
                                      cumplots2,
                                      cumplots_diff2, 
                                      nrow=5, align="hv", 
                                      rel_heights=c(1.5,10,10,10,10)) +
  theme(plot.background=element_rect(fill="white", color=NA))

#cumincplot_arrange

# ggsave(cumincplot_arrange, path="figures", filename="Figure4_cumincplots.jpeg", 
#        width=40, height=45, dpi=600)
```

## Fig5: Histograms and IRR plots for Outcomes 2 and 3

```{r HistIRRPlots, message=FALSE, warning=FALSE, results="asis"}
# Axis transformations
## DistinctDx histograms

# man.trans.histos_distinctDx_x <- function() {
#   domain <- c(0, Inf)
#   transform <- function(x) x^(4/5)
#   range <- transform(domain)
#   trans_new("man_trans_histos",
#             transform = transform,
#             inverse = function(x) squish(x, range=range)^(5/4),
#             domain = domain)
#   }

man.trans.histos_inpatTx_x <- function() {
  domain <- c(0, Inf)
  transform <- function(x) x^(1/2)
  range <- transform(domain)
  trans_new("man_trans_histos",
            transform = transform,
            inverse = function(x) squish(x, range=range)^(2/1),
            domain = domain)
  }



##########################################################################
# Outcome 2: Histograms
## DistinctDx
histoplot_df_comorb_distinctDx <- df_comorb_distinctDx %>%
  mutate(rn=1) %>% # Define "row number"
  mutate(model="Overall")

histoplot_df_comorb_distinctDx_mental <- df_comorb_distinctDx_mental %>%
  mutate(rn=2) %>% # Define "row number"
  mutate(model="MentalDiagnoses")

histoplot_df_comorb_distinctDx_somatic <- df_comorb_distinctDx_somatic %>%
  mutate(rn=3) %>% # Define "row number"
  mutate(model="SomaticDiagnoses")


histoplotdata_distinctDx <- bind_rows(histoplot_df_comorb_distinctDx,
                                      histoplot_df_comorb_distinctDx_mental,
                                      histoplot_df_comorb_distinctDx_somatic) %>%
  arrange(rn) %>%
  mutate(Group=fct_relevel(Group, c("Controls", "ARFID"))) %>%
  mutate(n_ARFID=length(unique(twin_id[Group=="ARFID"])))


label_distinctDx <- distinctDx_desc %>% 
  mutate(rn=1) %>% # Define "row number"
  mutate(model="Overall")

label_distinctDx_mental <- distinctDx_mental_desc %>% 
  mutate(rn=2) %>% # Define "row number"
  mutate(model="MentalDiagnoses")

label_distinctDx_somatic <- distinctDx_somatic_desc %>% 
  mutate(rn=3) %>% # Define "row number"
  mutate(model="SomaticDiagnoses")

labeldata_distinctDx <- bind_rows(label_distinctDx, 
                                  label_distinctDx_mental,
                                  label_distinctDx_somatic) %>%
  arrange(rn) %>%
  mutate(across(contains(c("mean", "sem")), ~ifelse(.x<0.01, 
                                                    formatC(.x, format="f", digits=3),
                                                    formatC(.x, format="f", digits=2)))) %>%
  unite("mean_sem", c(mean_distinctDx, sem_distinctDx), 
        sep="¬±", remove=TRUE, na.rm=FALSE) %>%
  mutate(label="(Mean¬±SEM)=") %>%
  unite("label", c(Group, label, mean_sem), 
        sep="", remove=FALSE, na.rm=FALSE)


histoplotlist_distinctDx=list()
histoplotlegendlist=list()

for (RN in unique(histoplotdata_distinctDx$rn)) {
  
  plotdata <- histoplotdata_distinctDx %>% filter(rn==RN)
  
  labels <- labeldata_distinctDx %>% filter(rn==RN) %>%
    distinct(label, .keep_all=TRUE)
  
  histos_leg <- ggplot(data=plotdata,
                       aes(x=distinctDx, group=Group, fill=Group)) +
    geom_histogram(aes(y=100*(..density..), group=Group, fill=Group), # Relative Frequency in %
                 alpha=0.65, color=NA, binwidth=1, position="identity") +
    geom_histogram(aes(y=-0.5*(..count../..count..), group=Group, fill=Group),
                 alpha=0.65, color=NA, binwidth=1, position="identity") +
    scale_x_continuous(#limits=c(NA, NA),
                       limits=c(NA, 46),
                       expand=c(0,0),
                       breaks=pretty_breaks(n=10), 
                       labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L),
                       #trans=man.trans.histos_distinctDx_x()
                       ) +
    scale_y_continuous(limits=c(-0.5, 100),
                       expand=expansion(mult=c(0,0.01)),
                       breaks=pretty_breaks(n=10), 
                       labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L), 
                       sec.axis=sec_axis(trans=~(./100)*unique(plotdata$n_ARFID), 
                                           name="Absolute Frequency in ARFID (count)",
                                           breaks=pretty_breaks(n=10))) +
    scale_fill_manual(values = alpha(c("#31439B", "#AB5E00", "#000000"), 1)) +
    scale_color_manual(values = alpha(c("#31439B", "#AB5E00", "#000000"), 1)) +
    geom_text(data=labels, aes(label=label[Group=="ARFID"]),
              x=Inf, y=Inf, hjust=1.08, vjust=3, size=10, color="#AB5E00") +
    geom_text(data=labels, aes(label=label[Group=="Controls"]),
              x=Inf, y=Inf, hjust=1.08, vjust=6, size=10, color="#31439B") +
    ylab("Relative Frequency in ARFID and Controls (%)") +
    ggtitle(plotdata$model) + 
    guides(fill=guide_legend(nrow=1, byrow=TRUE, reverse=TRUE),
           color=guide_legend(nrow=1, byrow=TRUE, reverse=TRUE)) +
    plot_theme_transparent + 
    theme(plot.margin=unit(c(1,2,1,0), "cm"), #t, r, b, l
          axis.line.x=element_line(color=NA, size=0),
          axis.text=element_text(size=27),
          axis.text.y.right=element_text(color="#AB5E00"),
          axis.title.y.left=element_text(margin=margin(t=0, r=15, b=0, l=0)),
          axis.title.y.right=element_text(color="#AB5E00", 
                                          margin=margin(t=0, r=0, b=0, l=15)),
          axis.title.x=element_text(margin=margin(t=15, r=0, b=0, l=0)),
          axis.line.y.right=element_line(color="#AB5E00"),
          axis.ticks.y.right=element_line(color="#AB5E00"),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(0.35, "cm"),
          axis.ticks.length.y=unit(0.35, "cm"),
          plot.title=element_text(vjust=1.75)) #+
    #coord_cartesian(ylim=c(-0.5, NA))
  
  histos <- histos_leg +
    theme(legend.position="none")
  
  if(plotdata$model=="MentalDiagnoses") {
    
    histos <- histos + xlab("Number of distinct diagnoses")
    }
  
  if(plotdata$model!="MentalDiagnoses") {
    
    histos <- histos + xlab("")
    }
  
  histoplotlist_distinctDx[[RN]]=histos
  histoplotlegendlist[[RN]]=histos_leg
  }

histoplotlist_legend <- get_legend(histoplotlegendlist[[1]])

histoplots_distinctDx <- cowplot::plot_grid(NA,histoplotlist_legend, NA,
                                 plotlist=histoplotlist_distinctDx, 
                                 ncol=3, nrow=2, align="h", 
                                 rel_widths=c(1,1,1), rel_heights=c(1,12),
                                 labels=c("A. Number of distinct diagnoses", rep("", 5)),
                                 label_x=-0.3,
                                 label_size=40) +
     theme(plot.background=element_rect(fill="white", color=NA))


# ggsave(histoplots_distinctDx, path="figures/test", filename="Figure5_Histo_DistinctDx.jpeg", 
#        width=45, height=30, dpi=600)



##########################################################################
# Outcome 3: Histograms
## InpatTx

### Axis ticks/breaks transformations
#### Inpatient treatment duration histograms
x.breaks.histos_inpatTx <- c(0,10,40,100,200,400,700,1000)

histoplot_df_comorb_inpatTx <- df_comorb_inpatTx %>%
  mutate(rn=1) %>% # Define "row number"
  mutate(model="Overall")

histoplot_df_comorb_inpatTx_mental <- df_comorb_inpatTx_mental %>%
  mutate(rn=2) %>% # Define "row number"
  mutate(model="MentalDiagnoses")

histoplot_df_comorb_inpatTx_somatic <- df_comorb_inpatTx_somatic %>%
  mutate(rn=3) %>% # Define "row number"
  mutate(model="SomaticDiagnoses")


histoplotdata_inpatTx <- bind_rows(histoplot_df_comorb_inpatTx,
                                      histoplot_df_comorb_inpatTx_mental,
                                      histoplot_df_comorb_inpatTx_somatic) %>%
  arrange(rn) %>%
  mutate(Group=fct_relevel(Group, c("Controls", "ARFID"))) %>%
  mutate(n_ARFID=length(unique(twin_id[Group=="ARFID"])))


label_inpatTx <- inpatTx_desc %>% 
  mutate(rn=1) %>% # Define "row number"
  mutate(model="Overall")

label_inpatTx_mental <- inpatTx_mental_desc %>% 
  mutate(rn=2) %>% # Define "row number"
  mutate(model="MentalDiagnoses")

label_inpatTx_somatic <- inpatTx_somatic_desc %>% 
  mutate(rn=3) %>% # Define "row number"
  mutate(model="SomaticDiagnoses")

labeldata_inpatTx <- bind_rows(label_inpatTx, 
                               label_inpatTx_mental,
                               label_inpatTx_somatic) %>%
  arrange(rn) %>%
  mutate(across(contains(c("mean", "sem")), ~ifelse(.x<0.01, 
                                                    formatC(.x, format="f", digits=3),
                                                    formatC(.x, format="f", digits=2)))) %>%
  unite("mean_sem", c(mean_inpatTx, sem_inpatTx), 
        sep="¬±", remove=TRUE, na.rm=FALSE) %>%
  mutate(label="(Mean¬±SEM)=") %>%
  unite("label", c(Group, label, mean_sem), 
        sep="", remove=FALSE, na.rm=FALSE)


histoplotlist_inpatTx=list()

for (RN in unique(histoplotdata_inpatTx$rn)) {
  
  plotdata <- histoplotdata_inpatTx %>% filter(rn==RN)
  
  labels <- labeldata_inpatTx %>% filter(rn==RN) %>%
    distinct(label, .keep_all=TRUE)
  
  histos <- ggplot(data=plotdata,
                   aes(x=sum_inpat_dur, group=Group, fill=Group)) +
    geom_histogram(aes(y=100*(..density..), group=Group, fill=Group), # Relative Frequency in %
                 color=NA, binwidth=1, alpha=0.65, position="identity") +
    geom_histogram(aes(y=-0.5*(..count../..count..), group=Group, fill=Group),
                 alpha=0.65, color=NA, binwidth=1, position="identity") +
    scale_x_continuous(limits=c(NA, 1150),
                       expand=c(0,0),
                       #breaks=pretty_breaks(n=10), 
                       breaks=x.breaks.histos_inpatTx, 
                       labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L), 
                       trans=man.trans.histos_inpatTx_x()
                       ) +
    scale_y_continuous(limits=c(-0.5, 100),
                       expand=expansion(mult=c(0,0.01)),
                       breaks=pretty_breaks(n=10), 
                       labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L), 
                       sec.axis=sec_axis(trans=~(./100)*unique(plotdata$n_ARFID), 
                                           name="Absolute Frequency in ARFID (count)",
                                           breaks=pretty_breaks(n=10))) +
    scale_fill_manual(values = alpha(c("#31439B", "#AB5E00", "#000000"), 1)) +
    scale_color_manual(values = alpha(c("#31439B", "#AB5E00", "#000000"), 1)) +
    geom_text(data=labels, aes(label=label[Group=="ARFID"]),
              x=Inf, y=Inf, hjust=1.08, vjust=3, size=10, color="#AB5E00") +
    geom_text(data=labels, aes(label=label[Group=="Controls"]),
              x=Inf, y=Inf, hjust=1.08, vjust=6, size=10, color="#31439B") +
    ylab("Relative Frequency in ARFID and Controls (%)") +
    ggtitle(plotdata$model) + 
    plot_theme_transparent + 
    theme(plot.margin=unit(c(3,2,1,0), "cm"), #t, r, b, l
          axis.line.x=element_line(color=NA, size=0),
          legend.position="none",
          axis.text=element_text(size=27),
          axis.text.y.right=element_text(color="#AB5E00"),
          axis.title.y.left=element_text(margin=margin(t=0, r=15, b=0, l=0)),
          axis.title.y.right=element_text(color="#AB5E00", 
                                          margin=margin(t=0, r=0, b=0, l=15)),
          axis.title.x=element_text(margin=margin(t=15, r=0, b=0, l=0)),
          axis.line.y.right=element_line(color="#AB5E00"),
          axis.ticks.y.right=element_line(color="#AB5E00"),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(0.35, "cm"),
          axis.ticks.length.y=unit(0.35, "cm"),
          plot.title=element_text(vjust=1.75)) +
    coord_cartesian(ylim=c(-0.5, NA))
  
  if(plotdata$model=="MentalDiagnoses") {
    
    histos <- histos + xlab("Number of inpatient days")
    }
  
  if(plotdata$model!="MentalDiagnoses") {
    
    histos <- histos + xlab("")
    }
  
  histoplotlist_inpatTx[[RN]]=histos
  }


histoplots_inpatTx <- cowplot::plot_grid(plotlist=histoplotlist_inpatTx, 
                                         ncol=3, nrow=1, align="h", 
                                         rel_widths=c(1,1,1),
                                         labels=c("B. Duration of inpatient treatment", 
                                                  rep("", 2)),
                                         label_x=-0.3,
                                         label_size=40) +
     theme(plot.background=element_rect(fill="white", color=NA))


# ggsave(histoplots_inpatTx, path="figures/test", filename="Figure5_Histo_InpatTx.jpeg", 
#        width=45, height=25, dpi=600)



##########################################################################
# Outcome 2: DistinctDx IRR plots

plot_glm_distinctDx <- glm_distinctDx_cluster %>%
  filter(term=="caseAC") %>%
  mutate(rn=1) %>% # Define "row number"
  mutate(model="Overall")

plot_glm_distinctDx_mental <- glm_distinctDx_mental_cluster %>%
  filter(term=="caseAC") %>%
  mutate(rn=2) %>% # Define "row number"
  mutate(model="Mental\nDiagnoses")

plot_glm_distinctDx_somatic <- glm_distinctDx_somatic_cluster %>%
  filter(term=="caseAC") %>%
  mutate(rn=3) %>% # Define "row number"
  mutate(model="Somatic\nDiagnoses")

irrplotdata_distinctDx <- bind_rows(plot_glm_distinctDx,
                                    plot_glm_distinctDx_mental,
                                    plot_glm_distinctDx_somatic) %>%
  mutate(p.value_f=ifelse(p.value<0.0001, "<0.0001", ifelse(p.value<0.001,
                                                            formatC(p.value, format="f",
                                                                    digits=4),
                                                            formatC(p.value, format="f",
                                                                    digits=3)))) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  mutate(p.label=ifelse(p.value<0.0001, "p", "p=")) %>% 
  unite("p.plot", c(p.label, p.value_f, sig), sep="", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(model, rn, coef, confint.low, confint.high, p.plot)


irrplots_distinctDx <- ggplot(data=irrplotdata_distinctDx, aes(x=coef, y=reorder(model, -rn))) +
    geom_vline(aes(xintercept=1), color="#AB5E00", linetype=3, size=4, alpha=1) +
    geom_errorbarh(aes(xmax=confint.high, xmin=confint.low, height=0.1), color="black", size=2, 
                   linetype="solid") +
    geom_point(aes(x=coef, y=model),
             color="black", alpha=1, size=7, shape=16) +
    scale_x_continuous(limits=c(0, 6),
                       expand=expansion(mult=c(0,0.03)),
                       breaks=pretty_breaks(n=8),
                       labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L)
                       #, trans=man.trans
                       ) +
    scale_y_discrete(aes(labels=model)) +
    theme(panel.grid.major.x=element_line(color="gray80",
                                          size=1.75,
                                          linetype=1)) +
    geom_text(aes(label=p.plot, x=coef, y=model), vjust=-1.8, hjust=0.35, size=10) +
    geom_text(label="HR=1", color="#AB5E00", x=1, y=-Inf, hjust=-0.06, vjust=-0.26, 
              fontface=4, size=10) +
    ggtitle("Number of distinct diagnoses") +
    xlab("IRR (95% CI) ARFID vs. Controls") +
    plot_theme_transparent +
    theme(plot.margin=unit(c(4,2,1,1), "cm"), #t, r, b, l
        legend.position="none",
        axis.text=element_text(size=27),
        axis.title.y=element_blank(),
        axis.title.x=element_text(margin=margin(t=20, r=0, b=0, l=0)),
        axis.ticks.x=element_line(size=1.75),
        axis.ticks.y=element_line(size=1.75), 
        axis.ticks.length.x=unit(0.35, "cm"),
        axis.ticks.length.y=unit(0.35, "cm"),
        plot.title=element_text(vjust=2.5))

# ggsave(irrplots_distinctDx, path="figures/test", filename="Figure5_IRR_DistinctDx.jpeg", 
#        width=30, height=30, dpi=600)



##########################################################################
# Outcome 3: InpatTx IRR plots

plot_glm_inpatTx <- glm_inpatTx_cluster %>%
  filter(term=="caseAC") %>%
  mutate(rn=1) %>% # Define "row number"
  mutate(model="Overall")

plot_glm_inpatTx_mental <- glm_inpatTx_mental_cluster %>%
  filter(term=="caseAC") %>%
  mutate(rn=2) %>% # Define "row number"
  mutate(model="Mental\nDiagnoses")

plot_glm_inpatTx_somatic <- glm_inpatTx_somatic_cluster %>%
  filter(term=="caseAC") %>%
  mutate(rn=3) %>% # Define "row number"
  mutate(model="Somatic\nDiagnoses")

irrplotdata_inpatTx <- bind_rows(plot_glm_inpatTx,
                                 plot_glm_inpatTx_mental,
                                 plot_glm_inpatTx_somatic) %>%
  mutate(p.value_f=ifelse(p.value<0.0001, "<0.0001", ifelse(p.value<0.001,
                                                            formatC(p.value, format="f",
                                                                    digits=4),
                                                            formatC(p.value, format="f",
                                                                    digits=3)))) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  mutate(p.label=ifelse(p.value<0.0001, "p", "p=")) %>% 
  unite("p.plot", c(p.label, p.value_f, sig), sep="", remove=FALSE, na.rm=FALSE) %>%
  dplyr::select(model, rn, coef, confint.low, confint.high, p.plot)


irrplots_inpatTx <- ggplot(data=irrplotdata_inpatTx, aes(x=coef, y=reorder(model, -rn))) +
    geom_vline(aes(xintercept=1), color="#AB5E00", linetype=3, size=4, alpha=1) +
    geom_errorbarh(aes(xmax=confint.high, xmin=confint.low, height=0.1), color="black", size=2, 
                   linetype="solid") +
    geom_point(aes(x=coef, y=model),
             color="black", alpha=1, size=7, shape=16) +
    scale_x_continuous(limits=c(0, 18),
                       expand=expansion(mult=c(0,0.03)),
                       breaks=pretty_breaks(n=8),
                       labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L)
                       #, trans=man.trans
                       ) +
    scale_y_discrete(aes(labels=model)) +
    theme(panel.grid.major.x=element_line(color="gray80",
                                          size=1.75,
                                          linetype=1)) +
    geom_text(aes(label=p.plot, x=coef, y=model), vjust=-1.8, hjust=0, size=10) +
    geom_text(label="HR=1", color="#AB5E00", x=1, y=-Inf, hjust=-0.06, vjust=-0.26, 
              fontface=4, size=10) +
    ggtitle("Duration of inpatient treatment") +
    xlab("IRR (95% CI) ARFID vs. Controls") +
    plot_theme_transparent +
    theme(plot.margin=unit(c(3,2,1,1), "cm"),  
        legend.position="none",
        axis.text=element_text(size=27),
        axis.title.y=element_blank(),
        axis.title.x=element_text(margin=margin(t=20, r=0, b=0, l=0)),
        axis.ticks.x=element_line(size=1.75),
        axis.ticks.y=element_line(size=1.75), 
        axis.ticks.length.x=unit(0.35, "cm"),
        axis.ticks.length.y=unit(0.35, "cm"),
        plot.title=element_text(vjust=2.5))

# ggsave(irrplots_inpatTx, path="figures/test", filename="Figure5_IRR_InpatTx.jpeg", 
#        width=30, height=30, dpi=600)



# Group plots for Figure 5

fig5_arrange_top <- cowplot::plot_grid(histoplots_distinctDx, irrplots_distinctDx,
                                   ncol=2, nrow=1, rel_widths=c(4,1), align="v")

fig5_arrange_bottom <- cowplot::plot_grid(histoplots_inpatTx, irrplots_inpatTx,
                                   ncol=2, nrow=1, rel_widths=c(4,1), align="v")

fig5_arrange <- cowplot::plot_grid(fig5_arrange_top, fig5_arrange_bottom,
                                   ncol=1, nrow=2, align="hv",
                                   rel_heights=c(1.15,1)) +
  theme(plot.background=element_rect(fill="white", color=NA))

# fig5_arrange

# ggsave(fig5_arrange, path="figures", filename="Figure5_histo_irr_plots.jpeg", 
#        width=45, height=42, dpi=600)
```



# SM

## Prevalence table (SM Table S3)

### Overall

```{r prevtable, message=FALSE, warning=FALSE, results="asis"}
prevtable_overall <- barplotdata %>%
  dplyr::select(chind, label, Group, n, perc_f, perc_order) %>%
  pivot_wider(names_from="Group", values_from=c("n", "perc_f")) %>%
  mutate(bracket01=" (", bracket02=")") %>%
  unite("ARFID_n_perc", c(n_ARFID, bracket01, perc_f_ARFID, bracket02), 
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("Controls_n_perc", c(n_Controls, bracket01, perc_f_Controls, bracket02),
        sep="", remove=TRUE, na.rm=FALSE) %>%
  group_by(chind) %>%
  arrange(desc(perc_order), .by_group=TRUE) %>%
  ungroup()

prevtable_overall %>%
  mutate(label=ifelse(label=="EntireChapter", chind, label)) %>%
  dplyr::select(-c(chind, n_ARFID, perc_f_ARFID, perc_order)) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Prevalence table overall") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### Per sex

```{r prevtablesex, message=FALSE, warning=FALSE, results="asis"}
barplotdata_filter <- prevtable_overall %>%
  dplyr::select(chind, label)

barplotdata_sex <- bind_rows(barplotdata_chapters_sex, 
                             barplotdata_diagnoses_sex,
                             barplotdata_disordergroups_sex) %>%
  dplyr::select(chind, label, caseAC, sex, n, perc_f) %>%
  pivot_wider(names_from=c("caseAC", "sex"), values_from=c("n", "perc_f")) %>%
  mutate(bracket01=" (", bracket02=")") %>%
  unite("ARFID_f_n_perc", c(n_ARFID_f, bracket01, perc_f_ARFID_f, bracket02), 
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("ARFID_m_n_perc", c(n_ARFID_m, bracket01, perc_f_ARFID_m, bracket02), 
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("Controls_f_n_perc", c(n_Controls_f, bracket01, perc_f_Controls_f, bracket02),
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("Controls_m_n_perc", c(n_Controls_m, bracket01, perc_f_Controls_m, bracket02),
        sep="", remove=TRUE, na.rm=FALSE)

barplotdata_filter %>%
  left_join(barplotdata_sex, by=c("chind", "label")) %>%
  mutate(label=ifelse(label=="EntireChapter", chind, label)) %>%
  dplyr::select(label, ARFID_f_n_perc, ARFID_m_n_perc,
                Controls_f_n_perc, Controls_m_n_perc) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Prevalence table per sex") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### Per age group

```{r prevtableage, message=FALSE, warning=FALSE, results="asis"}
barplotdata_age <- bind_rows(barplotdata_chapters_age, 
                             barplotdata_diagnoses_age,
                             barplotdata_disordergroups_age) %>%
  dplyr::select(chind, label, caseAC, timegroup, n, perc_f) %>%
  pivot_wider(names_from=c("caseAC", "timegroup"), values_from=c("n", "perc_f")) %>%
  mutate(bracket01=" (", bracket02=")") %>%
  unite("ARFID_0to6_n_perc", c(n_ARFID_0to6, bracket01, perc_f_ARFID_0to6, bracket02), 
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("ARFID_6to12_n_perc", c(n_ARFID_6to12, bracket01, perc_f_ARFID_6to12, bracket02), 
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("ARFID_12to18_n_perc", c(n_ARFID_12to18, bracket01, perc_f_ARFID_12to18, bracket02), 
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("Controls_0to6_n_perc", c(n_Controls_0to6, bracket01, perc_f_Controls_0to6, bracket02),
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("Controls_6to12_n_perc", c(n_Controls_6to12, bracket01, 
                                   perc_f_Controls_6to12, bracket02),
        sep="", remove=FALSE, na.rm=FALSE) %>%
  unite("Controls_12to18_n_perc", c(n_Controls_12to18, bracket01, 
                                   perc_f_Controls_12to18, bracket02),
        sep="", remove=TRUE, na.rm=FALSE)


barplotdata_filter %>%
  left_join(barplotdata_age, by=c("chind", "label")) %>%
  mutate(label=ifelse(label=="EntireChapter", chind, label)) %>%
  dplyr::select(label, ARFID_0to6_n_perc, ARFID_6to12_n_perc, ARFID_12to18_n_perc,
                Controls_0to6_n_perc, Controls_6to12_n_perc, Controls_12to18_n_perc) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Prevalence table per age group") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

## Coxreg tables 

### Base Model (SM Table S4)

```{r tablecoxregbase, message=FALSE, warning=FALSE, results="asis"}
tablecoxregbase <- bind_rows(coxreg_base,
          coxreg_diagnoses_base,
          coxreg_disordergroups_base) %>%
  filter(term=="caseAC") %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=TRUE) %>%
  mutate(order=ifelse(label=="EntireChapter", 1000, estimate)) %>%
  group_by(chind) %>%
  arrange(desc(order), .by_group=TRUE) %>%
  ungroup() %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(across(c(estimate, robust.se, statistic, conf.low, conf.high),
                     ~formatC(., format="f", digits=2))) %>% 
  mutate(label=ifelse(label=="EntireChapter", chind, label)) %>%
  dplyr::select(label, estimate, robust.se,
                statistic, p.value, sig, conf.low, conf.high)

tablecoxregbase %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Cox regression base (adjusted for sex and birth year)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10") 
```

### Sex-stratified model (SM Table S8)

```{r tablecoxregsex, message=FALSE, warning=FALSE, results="asis"}
labelorder <- tablecoxregbase %>%
  dplyr::select(label)

tablecoxregpersex <- bind_rows(coxreg_sexstrata_persex,
                               coxreg_diagnoses_sexstrata_persex,
                               coxreg_disordergroups_sexstrata_persex) %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=TRUE) %>%
  mutate(sex=ifelse(str_detect(term, "1:caseAC"), "female", "male")) %>%
  mutate(label=ifelse(label=="EntireChapter", chind, label)) %>%
  dplyr::select(label, sex, estimate, p.value, conf.low, conf.high) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(across(c(estimate, conf.low, conf.high),
                ~formatC(., format="f", digits=2))) %>%
  pivot_wider(names_from="sex", values_from=c("estimate", "p.value", "conf.low", "conf.high")) %>%
  dplyr::select(label, contains("female"), contains("male"))


tablecoxregcompsex <- bind_rows(coxreg_sexstrata_compsex,
                               coxreg_diagnoses_sexstrata_compsex,
                               coxreg_disordergroups_sexstrata_compsex) %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=TRUE) %>%
  mutate(chind_new=ifelse(label=="EntireChapter",
                          "",
                          str_extract(chind, "([A-Z]:)"))) %>%
  mutate(chind_new=ifelse(is.na(chind_new), "", chind_new)) %>%
  mutate(label=ifelse(label=="EntireChapter", chind, label)) %>%
  unite("label_new", c(chind_new, label), sep="", remove=FALSE, na.rm=FALSE) %>%
  mutate(HR_femaleVSmale=estimate) %>%
  mutate(sig=as.character(asterisk_function_SM(p.value))) %>%
  mutate(sig_raw=as.character(asterisk_function(p.value))) %>%
  dplyr::select(label_new, label, HR_femaleVSmale, p.value, sig, conf.low, conf.high, sig_raw) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(across(c(HR_femaleVSmale, conf.low, conf.high),
                ~formatC(., format="f", digits=2)))

labelorder %>%
  inner_join(tablecoxregpersex, by="label") %>%
  inner_join(tablecoxregcompsex, by="label") %>%
  arrange(desc(HR_femaleVSmale)) %>%
  dplyr::select(-label) %>%
  dplyr::select(label_new, everything()) %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Cox regression sex-stratified (adjusted for birth year)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

### Age group-stratified model (SM Table S11)

```{r tablecoxregage, message=FALSE, warning=FALSE, results="asis"}
tablecoxregperage <- bind_rows(coxreg_agestrata_perage,
                               coxreg_diagnoses_agestrata_perage,
                               coxreg_disordergroups_agestrata_perage) %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=TRUE) %>%
  mutate(agegroup=ifelse(str_detect(term, "2:caseAC"), "6 to <12 years", 
                         ifelse(str_detect(term, "1:caseAC"), "0 to <6 years",
                                "12 to <18 years"))) %>%
  mutate(label=ifelse(label=="EntireChapter", chind, label)) %>%
  dplyr::select(label, agegroup, estimate, p.value, conf.low, conf.high) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(across(c(estimate, conf.low, conf.high),
                ~formatC(., format="f", digits=2))) %>%
  pivot_wider(names_from="agegroup", values_from=c("estimate", "p.value", "conf.low", "conf.high")) %>%
  dplyr::select(label, contains("0 to <6 years"), contains("6 to <12 years"), contains("12 to <18 years"))


tablecoxregcompage <- bind_rows(coxreg_agestrata_compage,
                                coxreg_diagnoses_agestrata_compage,
                                coxreg_disordergroups_agestrata_compage) %>%
  separate(comorb, c("chind", "label"), sep="\\.", remove=TRUE) %>%
  mutate(chind_new=ifelse(label=="EntireChapter",
                          "",
                          str_extract(chind, "([A-Z]:)"))) %>%
  mutate(chind_new=ifelse(is.na(chind_new), "", chind_new)) %>%
  mutate(label=ifelse(label=="EntireChapter", chind, label)) %>%
  unite("label_new", c(chind_new, label), sep="", remove=FALSE, na.rm=FALSE) %>%
  mutate(comp=ifelse(str_detect(term, "1:caseAC"), "0 to <6 years vs. 6 to <12 years", 
                     "12 to <18 years vs. 6 to <12 years")) %>%
  mutate(sig=as.character(asterisk_function_SM(p.value))) %>%
  mutate(sig_raw=as.character(asterisk_function(p.value))) %>%
  dplyr::select(label_new, label, comp, estimate, p.value, sig, conf.low, conf.high, sig_raw) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3)))) %>%
  mutate(across(c(estimate, conf.low, conf.high),
                ~formatC(., format="f", digits=2))) %>%
  pivot_wider(names_from="comp", 
              values_from=c("estimate", "p.value", "sig", "conf.low", "conf.high", "sig_raw")) %>%
  dplyr::select(label_new, label, contains("0 to <6 years vs. 6 to <12 years"), 
                contains("12 to <18 years vs. 6 to <12 years"))


labelorder %>%
  inner_join(tablecoxregperage, by="label") %>%
  inner_join(tablecoxregcompage, by="label") %>%
  #drop_na() %>% 
  dplyr::select(-label) %>%
  dplyr::select(label_new, everything()) %>%
  arrange(.$"estimate_12 to <18 years vs. 6 to <12 years") %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Cox regression age group-stratified (adjusted for sex and birth year)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```

## Tables for number of distinct diagnoses (SM Tables S6 and S9) and inpatient treatment duration (SM Tables S7 and S10)

```{r analysisoutc23tables, message=FALSE, warning=FALSE, results="asis"}
# Main analysis 2
## Base model
distinctDx_desc_prep <- distinctDx_desc %>%
  distinct(Group, .keep_all=TRUE) %>%
  mutate(Model="All diagnoses")

distinctDx_mental_desc_prep <- distinctDx_mental_desc  %>%
  distinct(Group, .keep_all=TRUE) %>%
  mutate(Model="Mental diagnoses")

distinctDx_somatic_desc_prep <- distinctDx_somatic_desc  %>%
  distinct(Group, .keep_all=TRUE) %>%
  mutate(Model="Somatic diagnoses")

distinctDx_table_descr <- bind_rows(distinctDx_desc_prep,
          distinctDx_mental_desc_prep,
          distinctDx_somatic_desc_prep) %>%
  dplyr::select(Model, Group, mean_distinctDx, sem_distinctDx) %>%
  mutate(across(c(mean_distinctDx, sem_distinctDx),
                ~formatC(., format="f", digits=2))) %>%
  pivot_wider(names_from="Group", values_from=c("mean_distinctDx",
                                                "sem_distinctDx")) %>%
  dplyr::select(Model, contains("ARFID"), contains("Controls"))


glm_distinctDx_cluster_prep <- glm_distinctDx_cluster %>%
  filter(term=="caseAC") %>%
  mutate(Model="All diagnoses")

glm_distinctDx_mental_cluster_prep <- glm_distinctDx_mental_cluster %>%
  filter(term=="caseAC") %>%
  mutate(Model="Mental diagnoses")

glm_distinctDx_somatic_cluster_prep <- glm_distinctDx_somatic_cluster %>%
  filter(term=="caseAC") %>%
  mutate(Model="Somatic diagnoses")

distinctDx_table_stats <- bind_rows(glm_distinctDx_cluster_prep,
                                    glm_distinctDx_mental_cluster_prep,
                                    glm_distinctDx_somatic_cluster_prep) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  dplyr::select(Model, coef, se, z, p.value, sig, confint.low, confint.high) %>%
  mutate(across(c(coef, se, z, confint.low, confint.high),
                ~formatC(., format="f", digits=2))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3))))

distinctDx_table <- distinctDx_table_descr %>%
  left_join(distinctDx_table_stats, by="Model")


## Sex interaction effects
distinctDx_sex_desc_prep <- distinctDx_desc %>%
  mutate(Model="All diagnoses")

distinctDx_mental_sex_desc_prep <- distinctDx_mental_desc %>%
  mutate(Model="Mental diagnoses")

distinctDx_somatic_sex_desc_prep <- distinctDx_somatic_desc %>%
  mutate(Model="Somatic diagnoses")

distinctDx_sex_table_descr <- bind_rows(distinctDx_sex_desc_prep,
                                        distinctDx_mental_sex_desc_prep,
                                        distinctDx_somatic_sex_desc_prep) %>%
  dplyr::select(Model, Group, contains("sex")) %>%
  mutate(across(c(mean_distinctDx_sex, sem_distinctDx_sex),
                ~formatC(., format="f", digits=2))) %>%
  pivot_wider(names_from=c("Group", "sex_fctr"), values_from=c("mean_distinctDx_sex",
                                                              "sem_distinctDx_sex")) %>%
  dplyr::select(Model, contains("ARFID_female"), contains("ARFID_male"),
                contains("Controls_female"), contains("Controls_male"))


glm_distinctDx_sex_cluster_prep <- glm_distinctDx_sex_cluster %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  mutate(Model="All diagnoses")

glm_distinctDx_mental_sex_cluster_prep <- glm_distinctDx_mental_sex_cluster %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  mutate(Model="Mental diagnoses")

glm_distinctDx_somatic_sex_cluster_prep <- glm_distinctDx_somatic_sex_cluster %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  mutate(Model="Somatic diagnoses")

distinctDx_sex_table_stats <- bind_rows(glm_distinctDx_sex_cluster_prep,
                                    glm_distinctDx_mental_sex_cluster_prep,
                                    glm_distinctDx_somatic_sex_cluster_prep) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  dplyr::select(Model, coef, se, z, p.value, sig, confint.low, confint.high) %>%
  mutate(across(c(coef, se, z, confint.low, confint.high),
                ~formatC(., format="f", digits=2))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3))))
### Interaction effects are reported in the table
distinctDx_sex_table <- distinctDx_sex_table_descr %>%
  left_join(distinctDx_sex_table_stats, by="Model")




# Main analysis 3
## Base model
inpatTx_desc_prep <- inpatTx_desc %>%
  distinct(Group, .keep_all=TRUE) %>%
  mutate(Model="Any diagnosis")

inpatTx_mental_desc_prep <- inpatTx_mental_desc  %>%
  distinct(Group, .keep_all=TRUE) %>%
  mutate(Model="Mental diagnosis")

inpatTx_somatic_desc_prep <- inpatTx_somatic_desc  %>%
  distinct(Group, .keep_all=TRUE) %>%
  mutate(Model="Somatic diagnosis")

inpatTx_table_descr <- bind_rows(inpatTx_desc_prep,
          inpatTx_mental_desc_prep,
          inpatTx_somatic_desc_prep) %>%
  dplyr::select(Model, Group, mean_inpatTx, sem_inpatTx) %>%
  mutate(across(c(mean_inpatTx, sem_inpatTx),
                ~formatC(., format="f", digits=2))) %>%
  pivot_wider(names_from="Group", values_from=c("mean_inpatTx",
                                                "sem_inpatTx")) %>%
  dplyr::select(Model, contains("ARFID"), contains("Controls"))


glm_inpatTx_cluster_prep <- glm_inpatTx_cluster %>%
  filter(term=="caseAC") %>%
  mutate(Model="Any diagnosis")

glm_inpatTx_mental_cluster_prep <- glm_inpatTx_mental_cluster %>%
  filter(term=="caseAC") %>%
  mutate(Model="Mental diagnosis")

glm_inpatTx_somatic_cluster_prep <- glm_inpatTx_somatic_cluster %>%
  filter(term=="caseAC") %>%
  mutate(Model="Somatic diagnosis")

inpatTx_table_stats <- bind_rows(glm_inpatTx_cluster_prep,
                                    glm_inpatTx_mental_cluster_prep,
                                    glm_inpatTx_somatic_cluster_prep) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  dplyr::select(Model, coef, se, z, p.value, sig, confint.low, confint.high) %>%
  mutate(across(c(coef, se, z, confint.low, confint.high),
                ~formatC(., format="f", digits=2))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3))))

inpatTx_table <- inpatTx_table_descr %>%
  left_join(inpatTx_table_stats, by="Model")


## Sex interaction effects
inpatTx_sex_desc_prep <- inpatTx_desc %>%
  mutate(Model="Any diagnosis")

inpatTx_mental_sex_desc_prep <- inpatTx_mental_desc %>%
  mutate(Model="Mental diagnosis")

inpatTx_somatic_sex_desc_prep <- inpatTx_somatic_desc %>%
  mutate(Model="Somatic diagnosis")

inpatTx_sex_table_descr <- bind_rows(inpatTx_sex_desc_prep,
                                        inpatTx_mental_sex_desc_prep,
                                        inpatTx_somatic_sex_desc_prep) %>%
  dplyr::select(Model, Group, contains("sex")) %>%
  mutate(across(c(mean_inpatTx_sex, sem_inpatTx_sex),
                ~formatC(., format="f", digits=2))) %>%
  pivot_wider(names_from=c("Group", "sex_fctr"), values_from=c("mean_inpatTx_sex",
                                                              "sem_inpatTx_sex")) %>%
  dplyr::select(Model, contains("ARFID_female"), contains("ARFID_male"),
                contains("Controls_female"), contains("Controls_male"))


glm_inpatTx_sex_cluster_prep <- glm_inpatTx_sex_cluster %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  mutate(Model="Any diagnosis")

glm_inpatTx_mental_sex_cluster_prep <- glm_inpatTx_mental_sex_cluster %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  mutate(Model="Mental diagnosis")

glm_inpatTx_somatic_sex_cluster_prep <- glm_inpatTx_somatic_sex_cluster %>%
  filter(str_detect(term, "caseAC:sex")) %>%
  mutate(Model="Somatic diagnosis")

inpatTx_sex_table_stats <- bind_rows(glm_inpatTx_sex_cluster_prep,
                                    glm_inpatTx_mental_sex_cluster_prep,
                                    glm_inpatTx_somatic_sex_cluster_prep) %>%
  mutate(sig=as.character(asterisk_function_MS(p.value))) %>%
  dplyr::select(Model, coef, se, z, p.value, sig, confint.low, confint.high) %>%
  mutate(across(c(coef, se, z, confint.low, confint.high),
                ~formatC(., format="f", digits=2))) %>%
  mutate(p.value=ifelse(p.value<0.0001, "<0.0001", 
                          ifelse(p.value<0.001,
                                 formatC(p.value, format="f", digits=4),
                                 formatC(p.value, format="f", digits=3))))
### Interaction effects are reported in the table
inpatTx_sex_table <- inpatTx_sex_table_descr %>%
  left_join(inpatTx_sex_table_stats, by="Model")


# SM Tables
distinctDx_table %>% 
  knitr::kable(format="html", align="l", digits=2,
               caption="Poisson regression for number of distinct diagnoses") %>% 
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

distinctDx_sex_table %>% 
  knitr::kable(format="html", align="l", digits=2,
               caption="Poisson regression for number of distinct diagnoses, sex-specific effects") %>% 
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")


inpatTx_table %>% 
  knitr::kable(format="html", align="l", digits=2,
               caption="Poisson regression for number of inpatient days") %>% 
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

inpatTx_sex_table %>% 
  knitr::kable(format="html", align="l", digits=2,
               caption="Poisson regression for number of inpatient days, 
               sex-specific effects") %>% 
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```



## SM Figure S1: Cumulative incidence plots for absolute risk of individual conditions

```{r cumincplotdiagnoses, message=FALSE, warning=FALSE}
cumincplotdata_cancer <- df_crit_distinct_matched %>%
  dplyr::select(twin_id) %>%
  left_join(df_comorb_chapters, by="twin_id") %>%
  filter(str_detect(comorb, "ChapterC")) %>% # Exclude cancer
  mutate(chind="EntireChapterC:Cancer",
         chind_new="C:",
         label="EntireChapterC:Cancer",
         label_new="C:Cancer") %>%
  mutate(caseAC=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls"))) %>% 
  dplyr::rename(Group=caseAC) %>% 
  dplyr::select(twin_id, pair_id, Group, sex, byear, chind, label_new, 
                label, dxevent, age.at.diag, chind_new)

cumincplotdata_diagnoses_prep <- df_crit_distinct_matched %>%
  dplyr::select(twin_id) %>%
  left_join(df_comorb_diagnoses, by="twin_id") %>%
  filter(!str_detect(comorb, "ChapterP")) %>% # Exclude perinatal conditions
  separate(comorb, c("chind", "label"), sep="\\.", remove=TRUE) %>%
  mutate(chind_new=str_extract(chind, "([A-Z]:)")) %>%
  mutate(chind_new=ifelse(is.na(chind_new), "", chind_new)) %>%
  unite("label_new", c(chind_new, label), sep="", remove=FALSE, na.rm=FALSE) %>%
  mutate(caseAC=factor(caseAC, levels=c(1,0), labels=c("ARFID", "Controls"))) %>% 
  dplyr::rename(Group=caseAC) %>%
  bind_rows(cumincplotdata_cancer)

cumincplotdata_diagnoses <- labelorder %>%
  inner_join(cumincplotdata_diagnoses_prep, by="label") %>%
  dplyr::select(-chind_new) %>%
  nest(-c(label_new, label, chind)) %>%
  mutate(rn=factor(row_number())) %>%
  mutate(survfit=map(data, ~tidy(survfit(Surv(age.at.diag, dxevent) ~ Group,
                                         cluster=pair_id, data=.x)))) %>%
  unnest(survfit) %>%
  mutate(cumulinc=1-estimate,
           confint.low=1-conf.high,
           confint.high=1-conf.low)

cumincplotlist_diagnoses=list()
cuminclegendlist_diagnoses=list()


for (RN in unique(cumincplotdata_diagnoses$rn)) {
  
  survplotdata <- cumincplotdata_diagnoses %>% filter(rn==RN)
    
  survplot_leg <- ggplot(data=survplotdata, 
                         aes(x=time, y=cumulinc, 
                             ymin=confint.low, 
                             ymax=confint.high, fill=strata)) +
    geom_line(aes(group=strata, color=strata), 
              alpha=1, size=1.75) +
    geom_ribbon(aes(ymin=confint.low, 
                    ymax=confint.high, 
                    group=strata, fill=strata), 
                alpha=0.5, color=NA, outline.type="full") +
    scale_x_continuous(limits=c(0,18), 
                       breaks=c(0,3,6,9,12,15,18),
                       expand=c(0.05,0.1)) +
    expand_limits(y=0) +
    ggtitle(unique(survplotdata$label_new)) +
    scale_fill_manual(name="Group", 
                      labels=c("ARFID", "Controls"),
                      values=alpha(c("#AB5E00", "#31439B", "#000000"), 1)) +
    scale_color_manual(name="Group", 
                       labels=c("ARFID", "Controls"),
                       values=alpha(c("#AB5E00", "#31439B", "#000000"), 1)) +
    guides(fill=guide_legend(nrow=1, byrow=TRUE),
           color=guide_legend(nrow=1, byrow=TRUE)) +
    plot_theme_transparent +
    theme(plot.margin=unit(c(0.5,0.5,0.5,0.5), "cm"), #t, r, b, l
          plot.title=element_text(size=20, vjust=1.5),
          axis.title=element_blank(),
          axis.text.x=element_text(size=20),
          axis.text.y=element_text(size=20),
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(0.35, "cm"),
          axis.ticks.length.y=unit(0.35, "cm")) +
    theme(aspect.ratio=2/3)
  
  if(max(survplotdata$confint.high)>0.06) {
    
    survplot = survplot_leg +
      theme(legend.position="none") + 
      scale_y_continuous(limits=c(min(survplotdata$confint.low),
                                max(survplotdata$confint.high)*1.1),
                       breaks=pretty_breaks(n=6), 
                       expand=c(0,0),
                       labels=scales::comma_format(scale=100,
                                                   big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L))
  }
  
  if(max(survplotdata$confint.high)<=0.06) {
    
    survplot = survplot_leg +
      theme(legend.position="none") + 
      scale_y_continuous(limits=c(min(survplotdata$confint.low),
                                max(survplotdata$confint.high)*1.1),
                       breaks=pretty_breaks(n=6), 
                       expand=c(0,0),
                       labels=scales::comma_format(scale=100,
                                                   big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=0.1))
  }
 
  cumincplotlist_diagnoses[[RN]]=survplot 
  cuminclegendlist_diagnoses[[RN]]=survplot_leg 
  }

 
cumincplotlegend_diagnoses <- get_legend(cuminclegendlist_diagnoses[[1]]) 

cumincplot_arrange_diagnoses <- ggarrange(plotlist=cumincplotlist_diagnoses, 
                                          ncol=6, nrow=11,
                                legend.grob=cumincplotlegend_diagnoses) %>%
  annotate_figure(left=text_grob("Cumulative incidence (%)", 
                                   color="black", size=35, rot=90, vjust=0.8),
                  bottom=text_grob("Age (years)", color="black", size=35,
                                   vjust=0.15)) +
  theme(plot.background=element_rect(fill="white", color=NA))

#cumincplot_arrange_diagnoses

#ggsave(cumincplot_arrange_diagnoses, path="figures", filename="FigureS1_cumincplots_diagnoses.jpeg", 
       #width=33, height=45, dpi=600)
```


## Cumulative incidence table/absolute risk assessment (SM Table S5)

```{r cuminctable, message=FALSE, warning=FALSE, results="asis"}
cumincplotdata_ch_groups_table <- cumincplotdata %>%
  dplyr::select(chind, label, strata, time, cumulinc,
                confint.low, confint.high)

cumincplotdata_diagnoses_table <- cumincplotdata_diagnoses %>%
  dplyr::select(chind, label, strata, time, cumulinc,
                confint.low, confint.high)

cumincplotdata_table_prep <- bind_rows(cumincplotdata_ch_groups_table, 
                                  cumincplotdata_diagnoses_table)

cumincplotdata_table <- cumincplotdata_table_prep %>%
  mutate(Age6=abs(time-6), Age12=abs(time-12), Age18=abs(time-18)) %>%
  pivot_longer(contains("Age"), names_to="diff", values_to="diff_value") %>%
  group_by(label, strata, diff) %>%
  arrange(diff_value, .by_group=TRUE) %>%
  slice_head(n=1) %>%
  ungroup() %>%
  dplyr::rename(Group=strata) %>%
  mutate(Group=dplyr::recode(Group,
                             "Group=ARFID"="ARFID",
                             "Group=Controls"="Controls")) %>%
  mutate(across(c(cumulinc, confint.low, confint.high),
                ~formatC(., format="f", digits=4))) %>%
  dplyr::select(label, Group, diff, cumulinc, confint.low, confint.high) %>%
  pivot_wider(names_from=c("Group", "diff"), 
              values_from=c("cumulinc", "confint.low", "confint.high")) %>%
  dplyr::select(label, contains("ARFID_Age6"), contains("Controls_Age6"),
                contains("ARFID_Age12"), contains("Controls_Age12"),
                contains("ARFID_Age18"), contains("Controls_Age18"))

labelorder %>%
  left_join(cumincplotdata_table, by="label") %>%
  knitr::kable(format="html", align="l", digits=2,
               caption="Cumulative incidence at ages 6, 12, and 17.9 years for all conditions by group (ARFID vs. controls)") %>%
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")
```


## SM Figure S2: Spline plot for ChapterF:MentalConditions (to visualize significant age group effect)

```{r splineplotdata, message=FALSE, warning=FALSE, results="asis", eval=FALSE}
xt <-seq(0.0001,17.99999, len=1000)

df_spline_F <- df_comorb_chapters %>%
  dplyr::select(comorb, twin_id, pair_id, dxevent, age.at.diag, caseAC, sex, byear) %>%
  filter(str_detect(comorb, "Mental")) 

splines_F <- coxph(Surv(age.at.diag, dxevent) ~caseAC + tt(caseAC) + sex + byear, 
      cluster=pair_id, data=df_spline_F,
      tt=function(caseAC,t,...){caseAC*ns(t,knots=c(3,6,9,12,15),
                                          Boundary.knots=c(0.0001,17.99999))})

tidy(splines_F, conf.int=TRUE, conf.level=0.95, exponentiate=TRUE) %>% 
  knitr::kable(format="html", align="l", digits=2,
               caption="Entire chapter F: Mental disorders - Splines") %>% 
  kable_paper(bootstrap_options="striped", full_width=FALSE, 
              position="left", html_font="Arial", font_size="10")

xtMatrix <- cbind(1, ns(xt, knots=c(3,6,9,12,15),
                        Boundary.knots=c(0.0001,17.99999)))
xtSpline <- c(xtMatrix %*% splines_F$coef[1:7])

xtSE <- sqrt(diag(xtMatrix %*% (vcov(splines_F)[1:7,1:7]) %*% t(xtMatrix)))

xtCI_lower <- xtSpline - 1.96*xtSE
xtCI_upper <- xtSpline + 1.96*xtSE

splines_F_plotdata <- tibble(xt, xtSpline, xtCI_lower, xtCI_upper) %>% 
  mutate(xtSpline_exp=base::exp(xtSpline),
         xtCI_lower_exp=base::exp(xtCI_lower),
         xtCI_upper_exp=base::exp(xtCI_upper)) 

#splines_F_plotdata %>% write_csv("splineplotdata_chapterF.csv")
```


```{r splineplot, message=FALSE, warning=FALSE, eval=FALSE}
#splines_F_plotdata <- read_csv("splineplotdata_chapterF.csv")

# Plotting
splines_F_plot <- ggplot(splines_F_plotdata, aes(x=xt, y=xtSpline_exp)) +
  geom_line(aes(x=xt, y=xtSpline_exp), size=4, color="black") +
  geom_ribbon(aes(x=xt, y=xtSpline_exp, ymin=xtCI_lower_exp, ymax=xtCI_upper_exp),
              fill="gray50", alpha=0.5, color=NA) +
  scale_x_continuous(limits=c(0,18), 
                       breaks=c(0,3,6,9,12,15,18),
                       expand=c(0.05,0.1)) +
  scale_y_continuous(limits=c(min(splines_F_plotdata$xtCI_lower_exp),
                              max(splines_F_plotdata$xtCI_upper_exp)*1.05),
                     breaks=pretty_breaks(n=8), 
                     expand=c(0.05,0.1),
                     labels=scales::comma_format(big.mark=",",
                                                   decimal.mark=".",
                                                   accuracy=1L)) +
  xlab("Age (years)") +
  ylab("Age-varying HR (95% CI) in ARFID vs. Controls") +
  ggtitle("ChapterF:MentalConditions") +
  plot_theme_transparent +
  theme(plot.margin=unit(c(1,1,1,1), "cm"), #t, r, b, l
          axis.ticks.x=element_line(size=1.75),
          axis.ticks.y=element_line(size=1.75), 
          axis.ticks.length.x=unit(0.35, "cm"),
          axis.ticks.length.y=unit(0.35, "cm"),
          plot.title=element_text(vjust=1.5))

#splines_F_plot

#ggsave(splines_F_plot, path="figures", filename="FigureS2_splineplot_Fchapter.jpeg", 
       #width=30, height=20, dpi=600)
```
